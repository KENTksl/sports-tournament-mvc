<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partical/headercomponent'); %>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-bracket/0.11.1/jquery.bracket.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-bracket/0.11.1/jquery.bracket.min.css" />
    <style>
        /* Custom Styles for Tabs */
        .nav-pills .nav-link {
            border-radius: 5px;
            color: #333;
            font-weight: 600;
            background-color: #f8f9fa;
            margin-right: 5px;
            margin-bottom: 5px;
            border: 1px solid #dee2e6;
        }

        .nav-pills .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Bracket Styles */
        div.jQBracket .team {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            color: #333;
            font-weight: 600;
        }
        div.jQBracket .team.win {
            background-color: #e3f2fd;
            border-color: #0d6efd;
            color: #0d6efd;
        }
        div.jQBracket .score {
            background-color: #f1f1f1;
            color: #333;
            font-weight: bold;
        }

        /* Match Item Styles */
        .match-item {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            transition: all 0.2s;
        }
        .match-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .match-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        .team-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #eee;
        }
        
        /* Player Stats Badges */
        .badge-goal {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            color: #2c3e50;
            border: 1px solid #dcdcdc;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            margin-bottom: 2px;
            transform: scale(1);
            transition: transform 0.2s;
        }
        .badge-goal:hover {
            transform: scale(1.1);
        }
        .badge-goal i {
            margin-right: 4px;
            font-size: 11px;
            color: #2c3e50;
        }

        .badge-assist {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: 1px solid #2980b9;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            margin-bottom: 2px;
            transform: scale(1);
            transition: transform 0.2s;
        }
        .badge-assist:hover {
            transform: scale(1.1);
        }
        .badge-assist-icon {
            margin-right: 4px;
            font-weight: 900;
            font-size: 11px;
        }
    </style>
</head>

<body>
    <!-- Navbar Start -->
    <%- include('partical/menucomponent'); %>
    <!-- Navbar End -->

    <!-- Header Start -->
    <div class="container-fluid bg-primary py-5 px-0" style="margin-bottom: 90px;">
        <div class="row mx-0 align-items-center">
            <div class="col-lg-6 px-md-5 text-center text-lg-left">
                <h1 class="display-2 text-uppercase mb-3">
                    Chi Ti·∫øt Gi·∫£i ƒê·∫•u
                </h1>
                <p class="text-dark mb-4">
                    Th√¥ng tin chi ti·∫øt, l·ªãch thi ƒë·∫•u v√† k·∫øt qu·∫£.
                </p>
            </div>
            <div class="col-lg-6 px-0 text-right">
                <img class="img-fluid mt-5 mt-lg-0" src="/static/img/header.jpg" alt="">
            </div>
        </div>
    </div>
    <!-- Header End -->

    <!-- Detail Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <div class="mb-4">
                <a href="/football" class="btn btn-secondary">&larr; Quay l·∫°i danh s√°ch</a>
            </div>

            <!-- Tournament Info -->
            <div class="row mb-5">
                <div class="col-lg-4">
                    <img src="/static/uploads/tournaments/<%= tournament.image %>" onerror="this.src='/static/img/service-1.jpg'" class="img-fluid rounded w-100" alt="<%= tournament.name %>">
                </div>
                <div class="col-lg-8">
                    <h2 class="text-uppercase mb-3"><%= tournament.name %></h2>
                    <p><strong>BTC:</strong> <%= tournament.organizer %></p>
                    <p><strong>H√¨nh th·ª©c:</strong> <%= tournament.mode %></p>
                    <p><strong>S·ªë ƒë·ªôi:</strong> <%= tournament.teamsCount %></p>
                    <p><strong>Tr·∫°ng th√°i:</strong> 
                        <span class="badge badge-<%= tournament.status === 'ongoing' ? 'success' : (tournament.status === 'upcoming' ? 'warning' : 'secondary') %> p-2">
                            <%= tournament.status === 'ongoing' ? 'ƒêang di·ªÖn ra' : (tournament.status === 'upcoming' ? 'S·∫Øp di·ªÖn ra' : 'ƒê√£ k·∫øt th√∫c') %>
                        </span>
                    </p>
                    <p><strong>M√¥ t·∫£:</strong> <%= tournament.description || 'Ch∆∞a c√≥ m√¥ t·∫£' %></p>
                    
                    <% if (tournament.status === 'upcoming') { %>
                        <div class="mt-4">
                            <a href="/register-team?tournamentId=<%= tournament._id %>" class="btn btn-primary btn-lg px-5">ƒêƒÇNG K√ù GI·∫¢I</a>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-pills mb-4" id="tournamentTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="fixtures-tab" data-toggle="pill" href="#fixtures" role="tab" aria-controls="fixtures" aria-selected="true">L·ªãch ƒê·∫•u</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="standings-tab" data-toggle="pill" href="#standings" role="tab" aria-controls="standings" aria-selected="false">BXH</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="stats-tab" data-toggle="pill" href="#stats" role="tab" aria-controls="stats" aria-selected="false">Th·ªëng K√™</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="charts-tab" data-toggle="pill" href="#charts" role="tab" aria-controls="charts" aria-selected="false">Bi·ªÉu ƒê·ªì</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="bracket-tab" data-toggle="pill" href="#bracket" role="tab" aria-controls="bracket" aria-selected="false">Bracket</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="teams-tab" data-toggle="pill" href="#teams" role="tab" aria-controls="teams" aria-selected="false">C√°c ƒê·ªôi</a>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="tournamentTabContent">
                <!-- Fixtures Tab -->
                        <div class="tab-pane fade show active" id="fixtures" role="tabpanel" aria-labelledby="fixtures-tab">
                            <% if (tournament.fixtures && tournament.fixtures.length > 0) { %>
                                <% tournament.fixtures.forEach(group => { %>
                                    <div class="mb-4">
                                        <h5 class="text-primary font-weight-bold border-bottom pb-2 mb-3"><%= group.group %></h5>
                                        <% if (group.matches && group.matches.length > 0) { %>
                                            <% group.matches.forEach(match => { 
                                                let logo1 = 'default.png';
                                                let logo2 = 'default.png';
                                                if (tournament.teams) {
                                                    let t1 = tournament.teams.find(t => t.name === match.team1);
                                                    if (t1) logo1 = t1.logo;
                                                    let t2 = tournament.teams.find(t => t.name === match.team2);
                                                    if (t2) logo2 = t2.logo;
                                                }
                                            %>
                                                <div class="card mb-3 shadow-sm border-0 match-card">
                                                    <div class="card-body py-3">
                                                        <div class="row align-items-center">
                                                            <!-- Team 1 -->
                                                            <div class="col-5 text-right d-flex align-items-center justify-content-end">
                                                                <span class="font-weight-bold mr-3 d-none d-md-block"><%= match.team1 %></span>
                                                                <img src="/static/images/<%= logo1 %>" onerror="this.src='/static/images/default.png'" class="rounded-circle border" width="40" height="40" alt="<%= match.team1 %>">
                                                            </div>
                                                            
                                                            <!-- Score / Time -->
                                                            <div class="col-2 text-center">
                                                                <% if (match.score1 !== null && match.score1 !== undefined && match.score1 !== "") { %>
                                                                    <div class="font-weight-bold h5 mb-0 text-dark">
                                                                        <%= match.score1 %> - <%= match.score2 %>
                                                                    </div>
                                                                    <small class="text-success font-weight-bold">FT</small>
                                                                <% } else { %>
                                                                    <div class="badge badge-light border px-2 py-1 mb-1">VS</div>
                                                                    <small class="d-block text-muted"><%= match.time %></small>
                                                                    <small class="d-block text-muted"><%= match.date %></small>
                                                                <% } %>
                                                                
                                                                <button class="btn btn-sm btn-outline-primary mt-2 shadow-sm rounded-pill" data-match-id="<%= match.id %>" onclick="openMatchDetail('<%= match.id %>')">
                                                                    <i class="fa fa-eye"></i>
                                                                </button>
                                                            </div>

                                                            <!-- Team 2 -->
                                                            <div class="col-5 text-left d-flex align-items-center">
                                                                <img src="/static/images/<%= logo2 %>" onerror="this.src='/static/images/default.png'" class="rounded-circle border ml-0 ml-md-0" width="40" height="40" alt="<%= match.team2 %>">
                                                                <span class="font-weight-bold ml-3 d-none d-md-block"><%= match.team2 %></span>
                                                            </div>
                                                        </div>
                                                        <!-- Mobile Team Names -->
                                                        <div class="row d-md-none mt-2">
                                                            <div class="col-6 text-center"><small class="font-weight-bold"><%= match.team1 %></small></div>
                                                            <div class="col-6 text-center"><small class="font-weight-bold"><%= match.team2 %></small></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        <% } else { %>
                                            <p class="text-muted font-italic ml-3">Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u n√†o trong b·∫£ng n√†y.</p>
                                        <% } %>
                                    </div>
                                <% }) %>
                            <% } else { %>
                                <div class="alert alert-info text-center">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u.</div>
                            <% } %>
                        </div>

                        <!-- Standings Tab -->
                        <div class="tab-pane fade" id="standings" role="tabpanel" aria-labelledby="standings-tab">
                            <div class="card shadow-sm mb-4 border-0">
                                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 font-weight-bold">üìà B·∫£ng X·∫øp H·∫°ng</h5>
                                    <button onclick="exportImage('standings', 'BangXepHang')" class="btn btn-sm btn-outline-dark shadow-sm">
                                        <i class="fa fa-camera"></i> T·∫£i ·∫¢nh BXH
                                    </button>
                                </div>
                                <div class="card-body bg-white">
                                    <div class="row">
                                        <% if (tournament.standings && tournament.standings.length > 0) { %>
                                            <% tournament.standings.forEach(group => { %>
                                                <div class="col-lg-6 mb-4">
                                                    <h6 class="font-weight-bold text-primary pl-2 border-left border-primary mb-2" style="border-width: 4px !important;">
                                                        <%= group.groupName %>
                                                    </h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-hover table-sm table-bordered text-center align-middle mb-0" style="font-size: 14px;">
                                                            <thead class="thead-light">
                                                                <tr>
                                                                    <th class="text-left w-50">CLB</th>
                                                                    <th>Tr</th>
                                                                    <th>T</th>
                                                                    <th>H</th>
                                                                    <th>B</th>
                                                                    <th>HS</th>
                                                                    <th>ƒê</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <% group.teams.forEach((team, index) => { %>
                                                                    <tr class="<%= index < 2 ? 'table-success' : '' %>">
                                                                        <td class="text-left font-weight-bold text-nowrap px-2">
                                                                            <span class="mr-2 text-secondary"><%= index + 1 %></span>
                                                                            <img src="/static/images/<%= team.logo %>" width="20" height="20" class="rounded-circle border mr-1" onerror="this.src='/static/images/default.png'">
                                                                            <%= team.name %>
                                                                        </td>
                                                                        <td><%= team.played %></td>
                                                                        <td><%= team.won %></td>
                                                                        <td><%= team.drawn %></td>
                                                                        <td><%= team.lost %></td>
                                                                        <td><%= team.gd > 0 ? '+' + team.gd : team.gd %></td>
                                                                        <td class="font-weight-bold text-danger bg-light"><%= team.points %></td>
                                                                    </tr>
                                                                <% }) %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        <% } else { %>
                                            <div class="col-12 text-center text-muted">Ch∆∞a c√≥ b·∫£ng x·∫øp h·∫°ng.</div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>

                <!-- Stats Tab -->
                <div class="tab-pane fade" id="stats" role="tabpanel" aria-labelledby="stats-tab">
                    <div class="row">
                        <div class="col-lg-4 mb-3">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-success text-white fw-bold">üèÖ Vua Ph√° L∆∞·ªõi</div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th class="text-center" style="width:50px;">#</th>
                                                    <th>C·∫ßu th·ªß</th>
                                                    <th class="text-center" style="width:70px;">‚öΩ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topScorersBody">
                                                <tr><td colspan="3" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-primary text-white fw-bold">üëè Vua Ki·∫øn T·∫°o</div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th class="text-center" style="width:50px;">#</th>
                                                    <th>C·∫ßu th·ªß</th>
                                                    <th class="text-center" style="width:70px;">Assists</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topAssistsBody">
                                                <tr><td colspan="3" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-danger text-white fw-bold">üü• Th·∫ª Ph·∫°t</div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th class="text-center" style="width:50px;">#</th>
                                                    <th>C·∫ßu th·ªß</th>
                                                    <th class="text-center" style="width:70px;">Th·∫ª</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topCardsBody">
                                                <tr><td colspan="3" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Tab -->
                <div class="tab-pane fade" id="charts" role="tabpanel" aria-labelledby="charts-tab">
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold"><i class="fa fa-chart-bar me-2"></i> Ph√¢n T√≠ch ƒê·ªôi B√≥ng</h5>
                            <select id="chartTeamSelect" class="form-control w-auto" style="min-width: 200px;">
                                <option value="">-- Ch·ªçn ƒê·ªôi B√≥ng --</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-6 mb-4">
                                    <h6 class="text-center mb-3">T·ª∑ L·ªá K·∫øt Qu·∫£</h6>
                                    <div style="height: 300px; position: relative;">
                                        <canvas id="resultsChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-lg-6 mb-4">
                                    <h6 class="text-center mb-3">Hi·ªáu Su·∫•t Ghi B√†n Qua C√°c Tr·∫≠n</h6>
                                    <div style="height: 300px; position: relative;">
                                        <canvas id="goalsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bracket Tab -->
                <div class="tab-pane fade" id="bracket" role="tabpanel" aria-labelledby="bracket-tab">
                    <div class="bg-light p-4 rounded">
                        <h4 class="mb-4 text-uppercase">S∆° ƒê·ªì Thi ƒê·∫•u</h4>
                        <div id="bracket-container" style="overflow-x: auto;"></div>
                    </div>
                </div>

                <!-- Teams Tab -->
                <div class="tab-pane fade" id="teams" role="tabpanel" aria-labelledby="teams-tab">
                    <div class="bg-light p-4 rounded">
                        <h4 class="mb-4 text-uppercase">C√°c ƒê·ªôi Tham Gia</h4>
                        <div class="row">
                            <% if (tournament.teams && tournament.teams.length > 0) { %>
                                <% tournament.teams.forEach(team => { %>
                                    <div class="col-6 col-md-3 mb-4">
                                        <div class="card h-100 text-center p-3 shadow-sm border-0">
                                            <% 
                                                let logo = 'default.png';
                                                let name = 'Unknown';
                                                if (typeof team === 'string') {
                                                    name = team;
                                                } else if (typeof team === 'object') {
                                                    name = team.name;
                                                    logo = team.logo || 'default.png';
                                                }
                                            %>
                                            <img src="/static/images/<%= logo %>" onerror="this.src='/static/images/default.png'" class="img-fluid mx-auto d-block mb-3 rounded-circle border" style="width: 80px; height: 80px; object-fit: contain;">
                                            <h6 class="card-title mb-0 font-weight-bold"><%= name %></h6>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } else { %>
                                <p class="col-12 text-center">Ch∆∞a c√≥ danh s√°ch ƒë·ªôi.</p>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Detail End -->

    <!-- Match Detail Modal (Read Only) -->
    <div class="modal fade" id="matchDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="matchDetailTitle">Chi Ti·∫øt Tr·∫≠n ƒê·∫•u</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-0">
                    <!-- Score Header -->
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
                        <h4 class="text-primary mb-0 w-25 text-right" id="matchTeam1Name">Team 1</h4>
                        <div class="d-flex align-items-center justify-content-center w-50">
                            <span id="matchScore1" class="font-weight-bold h2 mb-0 mx-3">0</span>
                            <span class="font-weight-bold h3 mb-0">-</span>
                            <span id="matchScore2" class="font-weight-bold h2 mb-0 mx-3">0</span>
                        </div>
                        <h4 class="text-primary mb-0 w-25 text-left" id="matchTeam2Name">Team 2</h4>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs nav-fill" id="matchTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active font-weight-bold" id="lineup-tab-modal" data-toggle="tab" href="#lineup-modal" role="tab">
                                <i class="fa fa-users mr-2"></i>ƒê·ªôi H√¨nh
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link font-weight-bold" id="events-tab-modal" data-toggle="tab" href="#events-modal" role="tab">
                                <i class="fa fa-list-alt mr-2"></i>Di·ªÖn Bi·∫øn
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Lineup Tab -->
                        <div class="tab-pane fade show active" id="lineup-modal" role="tabpanel">
                            <div class="row no-gutters">
                                <!-- Team 1 Field -->
                                <div class="col-lg-6 border-right">
                                    <div class="p-2 text-center bg-light border-bottom font-weight-bold" id="lineupTeam1Name">Team 1</div>
                                    <div class="soccer-pitch-container">
                                        <div class="soccer-pitch" id="pitch-team1">
                                            <!-- Positions will be generated here -->
                                        </div>
                                    </div>
                                    <div class="p-3 bg-light border-top">
                                        <h6 class="text-muted small text-uppercase font-weight-bold mb-2">D·ª± b·ªã</h6>
                                        <div class="subs-container" id="subs-team1">
                                            <!-- Subs generated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Team 2 Field -->
                                <div class="col-lg-6">
                                    <div class="p-2 text-center bg-light border-bottom font-weight-bold" id="lineupTeam2Name">Team 2</div>
                                    <div class="soccer-pitch-container">
                                        <div class="soccer-pitch" id="pitch-team2">
                                            <!-- Positions will be generated here -->
                                        </div>
                                    </div>
                                    <div class="p-3 bg-light border-top">
                                        <h6 class="text-muted small text-uppercase font-weight-bold mb-2">D·ª± b·ªã</h6>
                                        <div class="subs-container" id="subs-team2">
                                            <!-- Subs generated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Events Tab -->
                        <div class="tab-pane fade" id="events-modal" role="tabpanel">
                            <div class="p-4">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-0">
                                        <thead>
                                            <tr class="text-center">
                                                <th style="width:80px;">Ph√∫t</th>
                                                <th>ƒê·ªôi</th>
                                                <th>C·∫ßu th·ªß</th>
                                                <th>S·ª± ki·ªán</th>
                                                <th>Ki·∫øn t·∫°o</th>
                                            </tr>
                                        </thead>
                                        <tbody id="eventListBodyPublic">
                                            <tr class="text-center text-muted"><td colspan="5">Ch∆∞a c√≥ di·ªÖn bi·∫øn n√†o</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .soccer-pitch-container {
            padding: 20px;
            background: #2e7d32;
            display: flex;
            justify-content: center;
        }
        .soccer-pitch {
            width: 300px;
            height: 400px;
            border: 2px solid rgba(255,255,255,0.8);
            position: relative;
            background-image: 
                linear-gradient(rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
            border-radius: 5px;
        }
        /* Center Circle */
        .soccer-pitch::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
        }
        /* Halfway Line */
        .soccer-pitch::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255,255,255,0.5);
        }

        .player-position {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .player-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #ddd;
            border: 2px solid white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .player-name {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            white-space: nowrap;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .position-label {
            position: absolute;
            top: -15px;
            color: rgba(255,255,255,0.8);
            font-size: 10px;
            font-weight: bold;
        }

        .subs-container {
            min-height: 60px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: white;
        }
        .sub-player {
            width: 60px;
            text-align: center;
        }
        .sub-player .player-avatar {
            width: 40px;
            height: 40px;
            margin: 0 auto 5px;
        }
        .sub-player .player-name {
            background: #6c757d;
            font-size: 9px;
        }
        .badge-goal {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            color: #2c3e50;
            border: 1px solid #dcdcdc;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            margin-bottom: 2px;
            transform: scale(1);
            transition: transform 0.2s;
        }
        .badge-goal:hover {
            transform: scale(1.1);
        }
        .badge-assist {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: 1px solid #2980b9;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            margin-bottom: 2px;
            transform: scale(1);
            transition: transform 0.2s;
        }
        .badge-assist:hover {
            transform: scale(1.1);
        }
        .badge-assist-icon {
            font-size: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 12px;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 3px;
        }
    </style>

    <script>
        const tournamentData = JSON.parse(decodeURIComponent('<%- encodeURIComponent(JSON.stringify(tournament)) %>'));
        const socket = typeof io !== 'undefined' ? io() : null;
        let currentOpenMatchId = null;

        if (socket) {
            socket.emit('join_tournament', tournamentData._id);
            socket.on('match_updated', (msg) => {
                if (!msg || !msg.matchId || !msg.payload) return;
                const { matchId, payload } = msg;
                // Update data
                if (tournamentData.fixtures) {
                    for (const group of tournamentData.fixtures) {
                        const m = group.matches.find(m => m.id === matchId);
                        if (m) {
                            if (payload.score1 !== undefined) m.score1 = payload.score1;
                            if (payload.score2 !== undefined) m.score2 = payload.score2;
                            if (payload.lineup1 !== undefined) m.lineup1 = payload.lineup1;
                            if (payload.lineup2 !== undefined) m.lineup2 = payload.lineup2;
                            if (payload.events !== undefined) m.events = payload.events;
                            if (payload.status !== undefined) m.status = payload.status;
                            break;
                        }
                    }
                }
                // Update UI score in fixtures list
                const btn = document.querySelector(`button[data-match-id="${matchId}"]`);
                if (btn) {
                    const col = btn.closest('.col-2');
                    if (col && payload.score1 !== undefined && payload.score2 !== undefined) {
                        const scoreEl = col.querySelector('.font-weight-bold.h5');
                        if (scoreEl) scoreEl.innerText = `${payload.score1} - ${payload.score2}`;
                        const ft = col.querySelector('.text-success.font-weight-bold');
                        if (ft) ft.innerText = 'FT';
                    }
                }
                // If modal open for this match
                if (document.getElementById('matchDetailModal') && $('#matchDetailModal').hasClass('show')) {
                    if (currentOpenMatchId === matchId) {
                        openMatchDetail(matchId);
                    }
                }

                // Re-render tournament stats when events change
                if (payload.events !== undefined) {
                    renderTournamentStats();
                }

                // Update charts if a team is selected and relevant data changed
                if (payload.score1 !== undefined || payload.score2 !== undefined || payload.events !== undefined) {
                    const chartSelect = document.getElementById('chartTeamSelect');
                    if (chartSelect && chartSelect.value && typeof updateTeamCharts === 'function') {
                        updateTeamCharts(chartSelect.value);
                    }
                }
            });
        }

        // Position Configs (Same as Admin)
        const PITCH_CONFIGS = {
            '5': [
                {role: 'GK', top: '90%', left: '50%'},
                {role: 'DF', top: '70%', left: '30%'}, {role: 'DF', top: '70%', left: '70%'},
                {role: 'FW', top: '30%', left: '30%'}, {role: 'FW', top: '30%', left: '70%'}
            ],
            '7': [
                {role: 'GK', top: '90%', left: '50%'},
                {role: 'CD', top: '75%', left: '50%'},
                {role: 'LM', top: '50%', left: '15%'}, {role: 'RM', top: '50%', left: '85%'}, {role: 'CM', top: '50%', left: '50%'},
                {role: 'FW', top: '25%', left: '35%'}, {role: 'FW', top: '25%', left: '65%'}
            ]
        };

        function openMatchDetail(matchId) {
            currentOpenMatchId = matchId;
            let currentMatch = null;
            // Find match
            if (tournamentData.fixtures) {
                for (const group of tournamentData.fixtures) {
                    const m = group.matches.find(m => m.id === matchId);
                    if (m) {
                        currentMatch = m;
                        break;
                    }
                }
            }

            if (!currentMatch) return;

            // Populate Header
            document.getElementById('matchTeam1Name').innerText = currentMatch.team1;
            document.getElementById('matchTeam2Name').innerText = currentMatch.team2;
            document.getElementById('matchScore1').innerText = (currentMatch.score1 !== null && currentMatch.score1 !== undefined) ? currentMatch.score1 : '-';
            document.getElementById('matchScore2').innerText = (currentMatch.score2 !== null && currentMatch.score2 !== undefined) ? currentMatch.score2 : '-';

            // Determine Pitch Type
            let pitchType = '7'; // Default
            if (tournamentData.pitchType) {
                pitchType = tournamentData.pitchType;
            } else if (tournamentData.mode) {
                if (tournamentData.mode.includes('5')) pitchType = '5';
            }

            // Render Lineups
            const positions = PITCH_CONFIGS[pitchType] || PITCH_CONFIGS['7'];

            renderTeamLineup('team1', currentMatch.team1, currentMatch.lineup1 || [], positions, currentMatch);
            renderTeamLineup('team2', currentMatch.team2, currentMatch.lineup2 || [], positions, currentMatch);

            renderPublicEvents(currentMatch);

            // Show Modal
            $('#matchDetailModal').modal('show');
        }

        function renderTeamLineup(side, teamName, currentLineup, positions, currentMatch) {
            const team = tournamentData.teams.find(t => t.name === teamName);
            const members = team ? (team.members || []) : [];
            
            const pitchContainer = document.getElementById(`pitch-${side}`);
            const subsContainer = document.getElementById(`subs-${side}`);
            
            pitchContainer.innerHTML = '';
            subsContainer.innerHTML = '';

            // 1. Render Pitch Positions
            positions.forEach((pos, index) => {
                const posDiv = document.createElement('div');
                posDiv.className = 'player-position';
                posDiv.style.top = pos.top;
                posDiv.style.left = pos.left;

                // Check if player is assigned
                const assignedPlayerId = currentLineup[index];
                const player = assignedPlayerId ? members.find(m => m.id === assignedPlayerId || m.name === assignedPlayerId) : null;

                if (player) {
                    const status = getPlayerDisciplinaryStatusPublic(player, side, currentMatch);
                    const stats = getPlayerEventStatsPublic(player, side, currentMatch);
                    const sentOffStyle = status.sentOff ? 'opacity:0.35; filter: grayscale(80%);' : '';
                    
                    let badgesHtml = '';
                    if (stats.goals > 0) badgesHtml += `<div class="badge-goal" title="B√†n th·∫Øng"><i class="fa fa-futbol"></i> ${stats.goals}</div>`;
                    if (stats.assists > 0) badgesHtml += `<div class="badge-assist" title="Ki·∫øn t·∫°o"><span class="badge-assist-icon">A</span> ${stats.assists}</div>`;
                    if (status.yellow > 0) badgesHtml += `<span class="badge" style="background:#f1c40f;color:#000; font-size: 0.6rem; padding: 2px 4px; margin-top:1px;">${status.yellow}</span>`;
                    if (status.red > 0) badgesHtml += `<span class="badge bg-danger" style="font-size: 0.6rem; padding: 2px 4px; margin-top:1px;">1</span>`;

                    posDiv.innerHTML = `
                        <div class="position-label">${pos.role}</div>
                        <div style="position: relative; display: inline-block;">
                            <div class="player-avatar" style="${sentOffStyle}">
                                ${player.avatar && player.avatar !== 'default-avatar.png' ? 
                                    `<img src="/static/uploads/tournaments/${player.avatar}">` : 
                                    `<i class="fa fa-user text-secondary"></i>`}
                            </div>
                            <div style="position:absolute; top:-8px; right:-12px; display:flex; flex-direction:column; align-items:center; gap:1px; z-index:100;">
                                ${badgesHtml}
                            </div>
                        </div>
                        <div class="player-name">${player.name}</div>
                    `;
                } else {
                    posDiv.innerHTML = `
                        <div class="position-label">${pos.role}</div>
                        <div class="player-avatar bg-transparent border-dashed" style="border-style: dashed; opacity: 0.5;">
                            
                        </div>
                        
                    `;
                }
                pitchContainer.appendChild(posDiv);
            });

            // 2. Render Subs (Everyone not in lineup)
            members.forEach(member => {
                const isInLineup = currentLineup.includes(member.id) || currentLineup.includes(member.name);
                
                if (!isInLineup) {
                    const status = getPlayerDisciplinaryStatusPublic(member, side, currentMatch);
                    const stats = getPlayerEventStatsPublic(member, side, currentMatch);
                    const sentOffStyle = status.sentOff ? 'opacity:0.35; filter: grayscale(80%);' : '';
                    
                    let badgesHtml = '';
                    if (stats.goals > 0) badgesHtml += `<div class="badge-goal" title="B√†n th·∫Øng"><i class="fa fa-futbol"></i> ${stats.goals}</div>`;
                    if (stats.assists > 0) badgesHtml += `<div class="badge-assist" title="Ki·∫øn t·∫°o"><span class="badge-assist-icon">A</span> ${stats.assists}</div>`;
                    if (status.yellow > 0) badgesHtml += `<span class="badge" style="background:#f1c40f;color:#000; font-size: 0.6rem; padding: 2px 4px; margin-top:1px;">${status.yellow}</span>`;
                    if (status.red > 0) badgesHtml += `<span class="badge bg-danger" style="font-size: 0.6rem; padding: 2px 4px; margin-top:1px;">1</span>`;

                    const subDiv = document.createElement('div');
                    subDiv.className = 'sub-player';
                    subDiv.innerHTML = `
                        <div style="position: relative; display: inline-block;">
                            <div class="player-avatar" style="${sentOffStyle}">
                                ${member.avatar && member.avatar !== 'default-avatar.png' ? 
                                    `<img src="/static/uploads/tournaments/${member.avatar}">` : 
                                    `<div class="bg-secondary w-100 h-100 d-flex align-items-center justify-content-center text-white"><i class="fa fa-user"></i></div>`}
                            </div>
                            <div style="position:absolute; top:-8px; right:-12px; display:flex; flex-direction:column; align-items:center; gap:1px; z-index:100;">
                                ${badgesHtml}
                            </div>
                        </div>
                        <div class="player-name">${member.name}</div>
                    `;
                    subsContainer.appendChild(subDiv);
                }
            });
        }

        function getPlayerDisciplinaryStatusPublic(player, side, currentMatch) {
            const events = currentMatch && currentMatch.events ? currentMatch.events : [];
            let yellow = 0, red = 0;
            events.forEach(ev => {
                let isTarget = false;
                if (ev.playerId && player.id && String(ev.playerId) === String(player.id)) {
                    isTarget = true;
                } else if (ev.playerName === player.name) {
                    if (!ev.playerId || !player.id) isTarget = true;
                }

                if (isTarget) {
                    if (ev.type === 'yellow') yellow++;
                    if (ev.type === 'red') red++;
                }
            });
            const sentOff = red >= 1 || yellow >= 2;
            return { yellow, red, sentOff };
        }

        function getPlayerEventStatsPublic(player, side, currentMatch) {
            const events = currentMatch && currentMatch.events ? currentMatch.events : [];
            let goals = 0, assists = 0;
            events.forEach(ev => {
                let isTarget = false;
                if (ev.playerId && player.id && String(ev.playerId) === String(player.id)) {
                    isTarget = true;
                } else if (ev.playerName === player.name) {
                    if (!ev.playerId || !player.id) isTarget = true;
                }

                if (isTarget) {
                    if (ev.type === 'goal') goals++;
                }

                let isAssist = false;
                if (ev.assistId && player.id && String(ev.assistId) === String(player.id)) {
                    isAssist = true;
                } else if (ev.assistName === player.name) {
                     if (!ev.assistId || !player.id) isAssist = true;
                }

                if (isAssist && ev.type === 'goal') {
                    assists++;
                }
            });
            return { goals, assists };
        }

        function renderPublicEvents(currentMatch) {
            const body = document.getElementById('eventListBodyPublic');
            if (!body) return;
            body.innerHTML = '';
            if (!currentMatch.events || currentMatch.events.length === 0) {
                body.innerHTML = '<tr class="text-center text-muted"><td colspan="5">Ch∆∞a c√≥ di·ªÖn bi·∫øn n√†o</td></tr>';
                return;
            }
            currentMatch.events.sort((a,b)=>a.minute-b.minute).forEach(ev=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">${ev.minute}</td>
                    <td>${ev.team === 'team1' ? currentMatch.team1 : currentMatch.team2}</td>
                    <td>${ev.playerName}</td>
                    <td class="text-center">${ev.type === 'goal' ? 'B√†n th·∫Øng' : ev.type === 'yellow' ? 'Th·∫ª v√†ng' : 'Th·∫ª ƒë·ªè'}</td>
                    <td>${ev.assistName || ''}</td>
                `;
                body.appendChild(tr);
            });
        }

        function renderTournamentStats() {
            const scorers = new Map();
            const assisters = new Map();
            const cards = new Map();

            function upsert(map, key, base) {
                if (!map.has(key)) map.set(key, Object.assign({ goals:0, assists:0, yellow:0, red:0 }, base));
                return map.get(key);
            }

            function findPlayerInfo(teamName, id, name) {
                const team = tournamentData.teams && tournamentData.teams.find(t => t.name === teamName);
                const members = team ? (team.members || []) : [];
                let player = null;
                if (id) player = members.find(m => String(m.id) === String(id));
                if (!player && name) player = members.find(m => m.name === name);
                const avatar = player && player.avatar ? player.avatar : 'default-avatar.png';
                const displayName = player ? player.name : (name || 'N/A');
                return { teamName, avatar, name: displayName, id: player ? player.id : (id || null) };
            }

            (tournamentData.fixtures || []).forEach(group => {
                (group.matches || []).forEach(m => {
                    (m.events || []).forEach(ev => {
                        // Goals
                        if (ev.type === 'goal') {
                            const info = findPlayerInfo(ev.teamName, ev.playerId, ev.playerName);
                            const k = info.id ? 'id:'+info.id : 'name:'+info.teamName+':'+info.name;
                            const row = upsert(scorers, k, info);
                            row.goals++;
                        }
                        // Assists
                        if (ev.type === 'goal' && (ev.assistId || ev.assistName)) {
                            const infoA = findPlayerInfo(ev.teamName, ev.assistId, ev.assistName);
                            const ka = infoA.id ? 'id:'+infoA.id : 'name:'+infoA.teamName+':'+infoA.name;
                            const rowA = upsert(assisters, ka, infoA);
                            rowA.assists++;
                        }
                        // Cards
                        if (ev.type === 'yellow' || ev.type === 'red') {
                            const infoC = findPlayerInfo(ev.teamName, ev.playerId, ev.playerName);
                            const kc = infoC.id ? 'id:'+infoC.id : 'name:'+infoC.teamName+':'+infoC.name;
                            const rowC = upsert(cards, kc, infoC);
                            if (ev.type === 'yellow') rowC.yellow++;
                            if (ev.type === 'red') rowC.red++;
                        }
                    });
                });
            });

            function renderBody(map, bodyId, valueGetter) {
                const body = document.getElementById(bodyId);
                if (!body) return;
                const arr = Array.from(map.values());
                arr.sort((a,b)=> valueGetter(b) - valueGetter(a));
                const top = arr.filter(x=> valueGetter(x) > 0).slice(0,10);
                body.innerHTML = '';
                if (top.length === 0) {
                    body.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                    return;
                }
                top.forEach((p, idx) => {
                    const total = valueGetter(p);
                    const avatar = p.avatar && p.avatar !== 'default-avatar.png' ? `/static/uploads/tournaments/${p.avatar}` : '/static/images/default.png';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-center">${idx+1}</td>
                        <td class="d-flex align-items-center">
                            <img src="${avatar}" class="rounded-circle border mr-2" width="28" height="28" onerror="this.src='/static/images/default.png'">
                            <span class="mr-2">${p.name}</span>
                            <small class="text-muted">(${p.teamName})</small>
                        </td>
                        <td class="text-center">${total}</td>
                    `;
                    body.appendChild(tr);
                });
            }

            renderBody(scorers, 'topScorersBody', (p)=>p.goals);
            renderBody(assisters, 'topAssistsBody', (p)=>p.assists);
            renderBody(cards, 'topCardsBody', (p)=>p.yellow + p.red);
        }

        document.addEventListener('DOMContentLoaded', function(){
            renderTournamentStats();
            initChartsTab();
        });

        // Chart Logic
        let resultsChart = null;
        let goalsChart = null;

        function initChartsTab() {
            const select = document.getElementById('chartTeamSelect');
            if (!select) return;

            // Populate teams
            const addedTeams = new Set();
            if (tournamentData.teams && tournamentData.teams.length > 0) {
                tournamentData.teams.forEach(team => {
                    const name = typeof team === 'string' ? team : team.name;
                    if (!addedTeams.has(name)) {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.innerText = name;
                        select.appendChild(opt);
                        addedTeams.add(name);
                    }
                });
            } else if (tournamentData.standings) {
                 tournamentData.standings.forEach(g => {
                     g.teams.forEach(t => {
                        if (!addedTeams.has(t.name)) {
                            const opt = document.createElement('option');
                            opt.value = t.name;
                            opt.innerText = t.name;
                            select.appendChild(opt);
                            addedTeams.add(t.name);
                        }
                     });
                 });
            }

            select.addEventListener('change', function() {
                updateTeamCharts(this.value);
            });
        }

        function updateTeamCharts(teamName) {
            if (!teamName) return;
            
            // Check Chart.js
            if (typeof Chart === 'undefined') {
                return;
            }

            // 1. Calculate Stats
            let wins = 0, draws = 0, losses = 0;
            const goalsPerMatch = []; // { match: 'L∆∞·ª£t X', goals: Y }
            
            // Collect all matches involving this team
            const matches = [];
            if (tournamentData.fixtures) {
                tournamentData.fixtures.forEach((group, gIdx) => {
                    group.matches.forEach((m, mIdx) => {
                        const t1 = (m.team1 || '').trim();
                        const t2 = (m.team2 || '').trim();
                        const target = teamName.trim();

                        if (t1 === target || t2 === target) {
                            // Check if match is finished (has score)
                            if (m.score1 !== null && m.score1 !== undefined && m.score1 !== "" &&
                                m.score2 !== null && m.score2 !== undefined && m.score2 !== "") {
                                matches.push({
                                    ...m, 
                                    groupName: group.group
                                });
                            }
                        }
                    });
                });
            }

            // Process matches
            matches.forEach((m, index) => {
                const isTeam1 = (m.team1 || '').trim() === teamName.trim();
                const score1 = parseInt(m.score1);
                const score2 = parseInt(m.score2);
                const myScore = isTeam1 ? score1 : score2;
                const opponentScore = isTeam1 ? score2 : score1;

                // Result
                if (myScore > opponentScore) wins++;
                else if (myScore === opponentScore) draws++;
                else losses++;

                // Goals
                goalsPerMatch.push({
                    label: m.groupName ? `${m.groupName} - Tr·∫≠n ${index+1}` : `Tr·∫≠n ${index + 1}`,
                    goals: myScore
                });
            });

            // 2. Render Results Chart (Donut)
            const canvasResult = document.getElementById('resultsChart');
            if (canvasResult) {
                const ctxResult = canvasResult.getContext('2d');
                if (resultsChart) resultsChart.destroy();
                
                // If no matches, show empty chart or just empty
                const data = matches.length > 0 ? [wins, draws, losses] : [0, 0, 0];
                const bgColors = matches.length > 0 ? ['#28a745', '#ffc107', '#dc3545'] : ['#e9ecef', '#e9ecef', '#e9ecef'];

                resultsChart = new Chart(ctxResult, {
                    type: 'doughnut',
                    data: {
                        labels: ['Th·∫Øng', 'H√≤a', 'Thua'],
                        datasets: [{
                            data: data,
                            backgroundColor: bgColors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: false }
                        }
                    }
                });
            }

            // 3. Render Goals Chart (Bar)
            const canvasGoals = document.getElementById('goalsChart');
            if (canvasGoals) {
                const ctxGoals = canvasGoals.getContext('2d');
                if (goalsChart) goalsChart.destroy();

                goalsChart = new Chart(ctxGoals, {
                    type: 'bar',
                    data: {
                        labels: goalsPerMatch.map(x => x.label),
                        datasets: [{
                            label: 'S·ªë b√†n th·∫Øng ghi ƒë∆∞·ª£c',
                            data: goalsPerMatch.map(x => x.goals),
                            backgroundColor: '#007bff',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        },
                        plugins: {
                            legend: { position: 'top' }
                        }
                    }
                });
            }
        }
    </script>

    <!-- Footer Start -->
    <%- include('partical/footercomponent'); %>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/static/lib/easing/easing.min.js"></script>
    <script src="/static/lib/waypoints/waypoints.min.js"></script>
    <script src="/static/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="/static/lib/tempusdominus/js/moment.min.js"></script>
    <script src="/static/lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="/static/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Template Javascript -->
    <script src="/static/js/main.js"></script>

    <script id="bracket-data" type="application/json">
        <%- JSON.stringify(tournament.bracketData || null) %>
    </script>

    <script>
        $(document).ready(function () {
            // Render Bracket if data exists
            var bracketData = null;
            try {
                var rawData = document.getElementById('bracket-data').textContent;
                if (rawData) {
                    bracketData = JSON.parse(rawData);
                }
            } catch (e) {
                console.error("Error parsing bracket data", e);
            }

            if (bracketData) {
                $('#bracket-container').bracket({
                    init: bracketData
                });
            } else {
                $('#bracket-container').html('<p class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu s∆° ƒë·ªì.</p>');
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        function exportImage(elementId, fileName) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Show loading or feedback if needed
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ƒêang t·∫£i...';
            btn.disabled = true;

            html2canvas(element).then(canvas => {
                const link = document.createElement('a');
                link.download = fileName + '.png';
                link.href = canvas.toDataURL();
                link.click();
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).catch(err => {
                console.error('Export failed:', err);
                alert('Kh√¥ng th·ªÉ t·∫£i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    </script>
</body>

</html>
