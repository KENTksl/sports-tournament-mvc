<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partical/headercomponent'); %>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-bracket/0.11.1/jquery.bracket.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-bracket/0.11.1/jquery.bracket.min.css" />
    <style>
        .jQBracket .team { color: #333; }
        .jQBracket .score { color: #333; }

        /* Custom Stats Badges */
        .badge-goal {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            color: #2c3e50;
            border: 1px solid #dcdcdc;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            margin-bottom: 2px;
        }
        .badge-goal i {
            margin-right: 4px;
            font-size: 11px;
            color: #2c3e50;
        }

        .badge-assist {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: 1px solid #2980b9;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            margin-bottom: 2px;
        }
        .badge-assist-icon {
            margin-right: 4px;
            font-weight: 900;
            font-size: 11px;
        }
    </style>
</head>

<body>
    <div class="container-fluid position-relative bg-white d-flex p-0">
        <!-- Spinner Start -->
        <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->

        <!-- Sidebar Start -->
        <%- include('../partical/menucomponent'); %>
        <!-- Sidebar End -->

        <!-- Content Start -->
        <div class="content">
            <!-- Navbar Start -->
            <%- include('../partical/navbarcomponent'); %>
            <!-- Navbar End -->

            <!-- Detail Start -->
            <div class="container-fluid pt-4 px-4">
                <div class="bg-light rounded h-100 p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h6 class="mb-0">Chi Tiết Giải Đấu: <%= tournament.name %></h6>
                        <a href="/admin/football/tournament" class="btn btn-secondary">Quay Lại</a>
                    </div>

                    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Thông Tin Chung</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button" role="tab">Danh Sách Đội</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="fixtures-tab" data-bs-toggle="tab" data-bs-target="#fixtures" type="button" role="tab">Lịch Thi Đấu</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="bracket-tab" data-bs-toggle="tab" data-bs-target="#bracket" type="button" role="tab">Sơ Đồ Thi Đấu</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="myTabContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Ban Tổ Chức:</strong> <%= tournament.organizer %></p>
                                    <p><strong>Chế Độ:</strong> <%= tournament.mode %></p>
                                    <p><strong>Số Đội:</strong> <%= tournament.teams ? tournament.teams.length : 0 %> / <%= tournament.teamsCount %></p>
                                    <p><strong>Trạng Thái:</strong> <%= tournament.status %></p>
                                    <p><strong>Mô Tả:</strong> <%= tournament.description %></p>
                                </div>
                                <div class="col-md-6">
                                    <% if (tournament.image && tournament.image !== 'default.png') { %>
                                        <img src="/static/uploads/tournaments/<%= tournament.image %>" class="img-fluid rounded" alt="Tournament Image">
                                    <% } %>
                                </div>
                            </div>
                        </div>

                        <!-- Teams Tab -->
                        <div class="tab-pane fade" id="teams" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeamModal" onclick="loadApprovedTeams()">Thêm Đội</button>
                            </div>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tên Đội</th>
                                        <th>Thành Viên</th>
                                        <th>Thống Kê (P/W/D/L/Pts)</th>
                                        <th>Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (tournament.teams && tournament.teams.length > 0) { %>
                                        <% tournament.teams.forEach((team, index) => { %>
                                            <tr>
                                                <td><%= index + 1 %></td>
                                                <td><%= team.name %></td>
                                                <td>
                                                    <%= team.members ? team.members.length : 0 %> thành viên
                                                </td>
                                                <td>
                                                    <% if (team.stats) { %>
                                                        <%= team.stats.p %> / <%= team.stats.w %> / <%= team.stats.d %> / <%= team.stats.l %> / <strong><%= team.stats.pts %></strong>
                                                    <% } else { %>
                                                        0 / 0 / 0 / 0 / <strong>0</strong>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editTeamModal<%= team.id %>">Sửa</button>
                                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#manageMembersModal<%= team.id %>">Thành Viên</button>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr><td colspan="5" class="text-center">Chưa có đội nào tham gia</td></tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>

                        <!-- Fixtures Tab -->
                        <div class="tab-pane fade" id="fixtures" role="tabpanel">
                            <% if (tournament.status === 'upcoming') { %>
                                <div class="alert alert-info text-center my-4">
                                    <h4><i class="bi bi-info-circle"></i> Giải đấu chưa bắt đầu</h4>
                                    <p class="mb-0">Lịch thi đấu sẽ được tạo tự động khi bạn nhấn nút <strong>"Bắt Đầu"</strong> ở danh sách giải đấu.</p>
                                </div>
                            <% } else { %>
                            <!-- Sub-Nav for Stages -->
                            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="pills-group-tab" data-bs-toggle="pill" data-bs-target="#pills-group" type="button" role="tab">Vòng Bảng</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="pills-knockout-tab" data-bs-toggle="pill" data-bs-target="#pills-knockout" type="button" role="tab">Vòng Trong</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="pills-tabContent">
                                <!-- Group Stage -->
                                <div class="tab-pane fade show active" id="pills-group" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">Danh sách trận đấu vòng bảng</h6>
                                        <form action="/admin/football/tournament/generate-bracket" method="POST" onsubmit="return confirm('Bạn có chắc chắn muốn kết thúc vòng bảng và tạo vòng đấu loại trực tiếp? Hành động này sẽ tạo ra các cặp đấu dựa trên BXH hiện tại.');">
                                            <input type="hidden" name="tournamentId" value="<%= tournament._id %>">
                                            <button type="submit" class="btn btn-success">
                                                <i class="bi bi-trophy"></i> Tạo Vòng Knockout
                                            </button>
                                        </form>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ngày/Giờ</th>
                                                    <th class="text-end">Đội 1</th>
                                                    <th class="text-center">Tỷ Số</th>
                                                    <th class="text-start">Đội 2</th>
                                                    <th>Trạng Thái</th>
                                                    <th>Hành Động</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (tournament.fixtures && tournament.fixtures.length > 0) { %>
                                                    <% let hasGroupMatches = false; %>
                                                    <% tournament.fixtures.forEach((group) => { %>
                                                        <% if (group.group && (group.group.startsWith('Bảng') || group.group.startsWith('Group'))) { %>
                                                            <% hasGroupMatches = true; %>
                                                            <tr class="table-secondary">
                                                                <td colspan="6" class="fw-bold text-uppercase"><%= group.group %></td>
                                                            </tr>
                                                            <% if (group.matches && group.matches.length > 0) { %>
                                                                <% group.matches.forEach((match) => { %>
                                                                    <tr>
                                                                        <td>
                                                                            <%= match.date %> <br>
                                                                            <small class="text-muted"><%= match.time %></small>
                                                                        </td>
                                                                        <td class="text-end fw-bold"><%= match.team1 %></td>
                                                                        <td class="text-center bg-light">
                                                                            <%= (match.score1 !== null && match.score1 !== undefined) ? match.score1 : '-' %> : <%= (match.score2 !== null && match.score2 !== undefined) ? match.score2 : '-' %>
                                                                        </td>
                                                                        <td class="text-start fw-bold"><%= match.team2 %></td>
                                                                        <td>
                                                                            <% if (match.score1 !== null && match.score1 !== undefined) { %>
                                                                                <span class="badge bg-success">Hoàn thành</span>
                                                                            <% } else { %>
                                                                                <span class="badge bg-warning text-dark">Sắp đá</span>
                                                                            <% } %>
                                                                        </td>
                                                                        <td>
                                                                            <% if (tournament.bracketData) { %>
                                                                                <button type="button" class="btn btn-sm btn-secondary" disabled>Đã khóa</button>
                                                                            <% } else { %>
                                                                                <button type="button" class="btn btn-sm btn-warning" data-match-id="<%= match.id %>" onclick="openMatchDetail('<%= match.id %>')">Cập Nhật</button>
                                                                            <% } %>
                                                                        </td>
                                                                    </tr>
                                                                <% }) %>
                                                            <% } else { %>
                                                                <tr><td colspan="6" class="text-center fst-italic">Chưa có trận đấu nào trong bảng này</td></tr>
                                                            <% } %>
                                                        <% } %>
                                                    <% }) %>
                                                    <% if (!hasGroupMatches) { %>
                                                        <tr><td colspan="6" class="text-center">Chưa có trận đấu vòng bảng nào.</td></tr>
                                                    <% } %>
                                                <% } else { %>
                                                    <tr><td colspan="6" class="text-center">Chưa có lịch thi đấu.</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Knockout Tab (Vòng Trong) -->
                                <div class="tab-pane fade" id="pills-knockout" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ngày/Giờ</th>
                                                    <th class="text-end">Đội 1</th>
                                                    <th class="text-center">Tỷ Số</th>
                                                    <th class="text-start">Đội 2</th>
                                                    <th>Trạng Thái</th>
                                                    <th>Hành Động</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (tournament.fixtures && tournament.fixtures.length > 0) { %>
                                                    <% let hasKO = false; %>
                                                    <% tournament.fixtures.forEach((group) => { %>
                                                        <% const isKO = group.group && (group.group.includes('Tứ Kết') || group.group.includes('Bán Kết') || group.group.includes('Chung Kết') || group.group.startsWith('Vòng 1/')); %>
                                                        <% if (isKO) { %>
                                                            <% hasKO = true; %>
                                                            <tr class="table-secondary">
                                                                <td colspan="6" class="fw-bold text-uppercase"><%= group.group %></td>
                                                            </tr>
                                                            <% if (group.matches && group.matches.length > 0) { %>
                                                                <% group.matches.forEach((match) => { %>
                                                                    <tr>
                                                                        <td>
                                                                            <%= match.date %> <br>
                                                                            <small class="text-muted"><%= match.time %></small>
                                                                        </td>
                                                                        <td class="text-end fw-bold"><%= match.team1 %></td>
                                                                        <td class="text-center bg-light">
                                                                            <%= (match.score1 !== null && match.score1 !== undefined) ? match.score1 : '-' %> : <%= (match.score2 !== null && match.score2 !== undefined) ? match.score2 : '-' %>
                                                                        </td>
                                                                        <td class="text-start fw-bold"><%= match.team2 %></td>
                                                                        <td>
                                                                            <% if (match.score1 !== null && match.score1 !== undefined) { %>
                                                                                <span class="badge bg-success">Hoàn thành</span>
                                                                            <% } else { %>
                                                                                <span class="badge bg-warning text-dark">Sắp đá</span>
                                                                            <% } %>
                                                                        </td>
                                                                        <td>
                                                                            <button type="button" class="btn btn-sm btn-warning" data-match-id="<%= match.id %>" onclick="openMatchDetail('<%= match.id %>')">Cập Nhật</button>
                                                                        </td>
                                                                    </tr>
                                                                <% }) %>
                                                            <% } %>
                                                        <% } %>
                                                    <% }) %>
                                                    <% if (!hasKO) { %>
                                                        <tr><td colspan="6" class="text-center fst-italic py-5">Chưa có trận Vòng Trong.</td></tr>
                                                    <% } %>
                                                <% } else { %>
                                                    <tr><td colspan="6" class="text-center">Chưa có dữ liệu.</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                        </div>

                        <!-- Bracket Tab -->
                        <div class="tab-pane fade" id="bracket" role="tabpanel">
                            <% if (tournament.status === 'upcoming') { %>
                                <div class="alert alert-info text-center my-4">
                                    <h4><i class="bi bi-info-circle"></i> Giải đấu chưa bắt đầu</h4>
                                    <p class="mb-0">Sơ đồ thi đấu sẽ được tạo tự động khi bạn nhấn nút <strong>"Bắt Đầu"</strong> ở danh sách giải đấu.</p>
                                </div>
                            <% } else { %>
                            <div class="bg-white p-3 rounded shadow-sm overflow-auto">
                                <h5 class="mb-3">Sơ Đồ Thi Đấu</h5>
                                <div id="bracket-container" style="min-width:600px; min-height:320px;"></div>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Detail End -->

            <!-- Footer Start -->
            <%- include('../partical/footercomponent'); %>
            <!-- Footer End -->
        </div>
        <!-- Content End -->

        <!-- Back to Top -->
        <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
    </div>

    <!-- MODALS SECTION (Outside main content) -->
    
    <!-- Add Team Modal (Static) -->
    <div class="modal fade" id="addTeamModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm Đội Bóng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/admin/football/tournament/add-team" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="tournamentId" value="<%= tournament._id %>">
                        <div class="mb-3">
                            <label class="form-label">Tên Đội</label>
                            <input type="text" class="form-control" name="teamName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Logo</label>
                            <input type="file" class="form-control" name="teamLogo" accept="image/*">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Thêm Đội</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Generated Team Modals -->
    <% if (tournament.teams && tournament.teams.length > 0) { %>
        <% tournament.teams.forEach((team) => { %>
            <!-- Edit Team Modal -->
            <div class="modal fade" id="editTeamModal<%= team.id %>" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Sửa Đội: <%= team.name %></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="/admin/football/tournament/update-team" method="POST" enctype="multipart/form-data">
                            <div class="modal-body">
                                <input type="hidden" name="tournamentId" value="<%= tournament._id %>">
                                <input type="hidden" name="teamId" value="<%= team.id %>">
                                
                                <div class="mb-3">
                                    <label class="form-label">Tên Đội</label>
                                    <input type="text" class="form-control" name="teamName" value="<%= team.name %>" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Logo</label>
                                    <input type="file" class="form-control" name="teamLogo" accept="image/*">
                                    <% if (team.logo && team.logo !== 'default.png') { %>
                                        <div class="mt-2">
                                            <small>Logo hiện tại:</small>
                                            <img src="/static/uploads/tournaments/<%= team.logo %>" width="50">
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                <button type="submit" class="btn btn-primary">Lưu Thay Đổi</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Manage Members Modal -->
            <div class="modal fade" id="manageMembersModal<%= team.id %>" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Thành viên: <%= team.name %></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Add Member Form -->
                            <form action="/admin/football/tournament/add-team-member" method="POST" enctype="multipart/form-data" class="mb-4 p-3 bg-light rounded" data-team-id="<%= team.id %>">
                                <input type="hidden" name="tournamentId" value="<%= tournament._id %>">
                                <input type="hidden" name="teamId" value="<%= team.id %>">
                                <div class="row align-items-end">
                                    <div class="col-md-5">
                                        <label class="form-label">Tên Cầu Thủ</label>
                                        <input type="text" class="form-control" name="memberName" required>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label">Avatar</label>
                                        <input type="file" class="form-control" name="memberAvatar" accept="image/*">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success w-100" onclick="submitAddMember(this)">Thêm</button>
                                    </div>
                                </div>
                            </form>

                            <!-- Members List -->
                            <h6>Danh sách cầu thủ (<span id="member-count-<%= team.id %>"><%= team.members ? team.members.length : 0 %></span>)</h6>
                            <ul class="list-group" id="member-list-<%= team.id %>">
                                <% if (team.members && team.members.length > 0) { %>
                                    <% team.members.forEach((member, i) => { %>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="fw-bold me-3"><%= i + 1 %>.</span>
                                                <% if (member.avatar && member.avatar !== 'default-avatar.png') { %>
                                                    <img src="/static/uploads/tournaments/<%= member.avatar %>" class="rounded-circle me-2" width="30" height="30">
                                                <% } else { %>
                                                    <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center text-white" style="width: 30px; height: 30px;">
                                                        <i class="fa fa-user"></i>
                                                    </div>
                                                <% } %>
                                                <span><%= member.name %></span>
                                            </div>
                                        </li>
                                    <% }) %>
                                <% } else { %>
                                    <li class="list-group-item text-center text-muted">Chưa có thành viên nào</li>
                                <% } %>
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
        <% }) %>
    <% } %>

    <!-- Match Detail Modal (Dynamic) -->
    <div class="modal fade" id="matchDetailModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="matchDetailTitle">Chi Tiết Trận Đấu</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Score Header -->
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
                        <h4 class="text-primary mb-0" id="matchTeam1Name">Team 1</h4>
                        <div class="d-flex align-items-center">
                            <input type="number" id="matchScore1" class="form-control text-center mx-2 fw-bold fs-4" style="width: 80px;" placeholder="0">
                            <span class="fw-bold fs-3">-</span>
                            <input type="number" id="matchScore2" class="form-control text-center mx-2 fw-bold fs-4" style="width: 80px;" placeholder="0">
                        </div>
                        <h4 class="text-primary mb-0" id="matchTeam2Name">Team 2</h4>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs nav-fill" id="matchTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold" id="lineup-tab" data-bs-toggle="tab" data-bs-target="#lineup" type="button" role="tab">
                                <i class="fa fa-users me-2"></i>Đội Hình & Sự Kiện
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab">
                                <i class="fa fa-list-alt me-2"></i>Diễn Biến (Nhập liệu)
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Lineup Tab -->
                        <div class="tab-pane fade show active" id="lineup" role="tabpanel">
                            <div class="row g-0">
                                <!-- Team 1 Field -->
                                <div class="col-lg-6 border-end">
                                    <div class="p-2 text-center bg-light border-bottom fw-bold" id="lineupTeam1Name">Team 1</div>
                                    <div class="soccer-pitch-container">
                                        <div class="soccer-pitch" id="pitch-team1">
                                            <!-- Positions will be generated here -->
                                        </div>
                                    </div>
                                    <div class="p-3 bg-light border-top">
                                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Dự bị (Kéo thả vào sân)</h6>
                                        <div class="subs-container" id="subs-team1" ondrop="drop(event)" ondragover="allowDrop(event)">
                                            <!-- Subs generated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Team 2 Field -->
                                <div class="col-lg-6">
                                    <div class="p-2 text-center bg-light border-bottom fw-bold" id="lineupTeam2Name">Team 2</div>
                                    <div class="soccer-pitch-container">
                                        <div class="soccer-pitch" id="pitch-team2">
                                            <!-- Positions will be generated here -->
                                        </div>
                                    </div>
                                    <div class="p-3 bg-light border-top">
                                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Dự bị (Kéo thả vào sân)</h6>
                                        <div class="subs-container" id="subs-team2" ondrop="drop(event)" ondragover="allowDrop(event)">
                                            <!-- Subs generated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Events Tab (Interactive) -->
                        <div class="tab-pane fade" id="events" role="tabpanel">
                            <div class="p-3">
                                <div class="row g-3">
                                    <div class="col-lg-4">
                                        <div class="card shadow-sm">
                                            <div class="card-header fw-bold">Thêm sự kiện mới</div>
                                            <div class="card-body">
                                                <div class="mb-2">
                                                    <label class="form-label">Đội bóng</label>
                                                    <select class="form-select" id="eventTeamSelect">
                                                        <option value="team1">Đội 1</option>
                                                        <option value="team2">Đội 2</option>
                                                    </select>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Phút</label>
                                                    <input type="number" class="form-control" id="eventMinute" placeholder="VD: 15" min="0" max="120">
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Loại</label>
                                                    <select class="form-select" id="eventTypeSelect">
                                                        <option value="goal">Bàn thắng</option>
                                                        <option value="yellow">Thẻ vàng</option>
                                                        <option value="red">Thẻ đỏ</option>
                                                    </select>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Cầu thủ</label>
                                                    <select class="form-select" id="eventPlayerSelect"></select>
                                                    <small class="text-muted">Chỉ cầu thủ đang ở trên sân; riêng thẻ cho phép chọn cả dự bị</small>
                                                </div>
                                                <div class="mb-2" id="assistContainer" style="display:none;">
                                                    <label class="form-label">Kiến tạo (không bắt buộc)</label>
                                                    <select class="form-select" id="assistPlayerSelect"></select>
                                                </div>
                                                <button class="btn btn-success w-100" onclick="addEvent()">
                                                    <i class="fa fa-plus me-2"></i>Thêm sự kiện
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-8">
                                        <div class="card shadow-sm">
                                            <div class="card-header d-flex justify-content-between align-items-center fw-bold">
                                                <span>Danh sách diễn biến</span>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="recomputeScoreFromEvents()">Cập nhật tỉ số theo sự kiện</button>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-bordered mb-0">
                                                        <thead>
                                                            <tr class="text-center">
                                                                <th style="width:80px;">Phút</th>
                                                                <th>Đội</th>
                                                                <th>Cầu thủ</th>
                                                                <th>Sự kiện</th>
                                                                <th>Kiến tạo</th>
                                                                <th style="width:60px;">Xóa</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="eventListBody">
                                                            <tr class="text-center text-muted"><td colspan="6">Chưa có diễn biến nào</td></tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-outline-primary" onclick="saveLineupOnly(event)">
                        <i class="fa fa-users me-2"></i>Lưu đội hình
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="saveEventsOnly(event)">
                        <i class="fa fa-save me-2"></i>Lưu diễn biến
                    </button>
                    <button type="button" class="btn btn-primary px-4" onclick="finishMatch(event)">
                        <i class="fa fa-flag-checkered me-2"></i>Kết thúc trận đấu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .soccer-pitch-container {
            padding: 20px;
            background: #2e7d32;
            display: flex;
            justify-content: center;
        }
        .soccer-pitch {
            width: 300px;
            height: 400px;
            border: 2px solid rgba(255,255,255,0.8);
            position: relative;
            background-image: 
                linear-gradient(rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
            border-radius: 5px;
        }
        /* Center Circle */
        .soccer-pitch::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
        }
        /* Halfway Line */
        .soccer-pitch::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255,255,255,0.5);
        }

        .player-position {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .player-position:hover {
            z-index: 10;
        }
        .player-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #ddd;
            border: 2px solid white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .player-name {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            white-space: nowrap;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .position-label {
            position: absolute;
            top: -15px;
            color: rgba(255,255,255,0.8);
            font-size: 10px;
            font-weight: bold;
        }

        .subs-container {
            min-height: 100px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: white;
        }
        .sub-player {
            width: 60px;
            text-align: center;
            cursor: grab;
        }
        .sub-player:active {
            cursor: grabbing;
        }
        .sub-player .player-avatar {
            width: 40px;
            height: 40px;
            margin: 0 auto 5px;
        }
        .sub-player .player-name {
            background: #6c757d;
            font-size: 9px;
        }
        .badge-goal {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            color: #2c3e50;
            border: 1px solid #dcdcdc;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            margin-bottom: 2px;
            transform: scale(1);
            transition: transform 0.2s;
        }
        .badge-goal:hover {
            transform: scale(1.1);
        }
        .badge-assist {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: 1px solid #2980b9;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            margin-bottom: 2px;
            transform: scale(1);
            transition: transform 0.2s;
        }
        .badge-assist:hover {
            transform: scale(1.1);
        }
        .badge-assist-icon {
            font-size: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 12px;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 3px;
        }
    </style>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/static/admin/lib/chart/chart.min.js"></script>
    <script src="/static/admin/lib/easing/easing.min.js"></script>
    <script src="/static/admin/lib/waypoints/waypoints.min.js"></script>
    <script src="/static/admin/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="/static/admin/lib/tempusdominus/js/moment.min.js"></script>
    <script src="/static/admin/lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="/static/admin/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Template Javascript -->
    <script src="/static/admin/js/main.js"></script>

    <script>
        const tournamentData = JSON.parse(decodeURIComponent('<%- encodeURIComponent(JSON.stringify(tournament)) %>'));
        const socket = typeof io !== 'undefined' ? io() : null;
        if (socket) {
            socket.emit('join_tournament', tournamentData._id);
            socket.on('match_updated', (msg) => {
                if (!msg || !msg.matchId || !msg.payload) return;
                const { matchId, payload } = msg;
                // Update local tournamentData
                if (tournamentData.fixtures) {
                    for (const group of tournamentData.fixtures) {
                        const m = group.matches.find(m => m.id === matchId);
                        if (m) {
                            if (payload.score1 !== undefined) m.score1 = payload.score1;
                            if (payload.score2 !== undefined) m.score2 = payload.score2;
                            if (payload.lineup1 !== undefined) m.lineup1 = payload.lineup1;
                            if (payload.lineup2 !== undefined) m.lineup2 = payload.lineup2;
                            if (payload.events !== undefined) m.events = payload.events;
                            if (payload.status !== undefined) m.status = payload.status;
                            break;
                        }
                    }
                }
                // Update list row if present
                const triggerBtn = document.querySelector(`[data-match-id="${matchId}"]`);
                if (triggerBtn) {
                    const row = triggerBtn.closest('tr');
                    if (row) {
                        if (payload.score1 !== undefined && payload.score2 !== undefined) {
                            const scoreCell = row.querySelector('td.text-center');
                            if (scoreCell) scoreCell.innerHTML = `${payload.score1} : ${payload.score2}`;
                            const statusCell = row.querySelector('td .badge');
                            if (statusCell && payload.status) {
                                statusCell.className = payload.status === 'finished' ? 'badge bg-success' : 'badge bg-warning text-dark';
                                statusCell.innerText = payload.status === 'finished' ? 'Hoàn thành' : 'Sắp đá';
                            }
                        }
                    }
                }
                // Update bracket results and re-render if needed
                if (tournamentData.bracketData && tournamentData.bracketData.results) {
                    let bm = null;
                    if (tournamentData.fixtures) {
                        for (const group of tournamentData.fixtures) {
                            const m = group.matches.find(m => m.id === matchId);
                            if (m && m.bracketRound !== undefined && m.bracketMatchIndex !== undefined) { bm = m; break; }
                        }
                    }
                    if (bm) {
                        const s1 = payload.score1 !== undefined ? parseInt(payload.score1) : (bm.score1 != null ? parseInt(bm.score1) : null);
                        const s2 = payload.score2 !== undefined ? parseInt(payload.score2) : (bm.score2 != null ? parseInt(bm.score2) : null);
                        const r = bm.bracketRound, i = bm.bracketMatchIndex;
                        if (tournamentData.bracketData.results[r] && tournamentData.bracketData.results[r][i]) {
                            tournamentData.bracketData.results[r][i] = [s1, s2];
                            if (document.getElementById('bracket') && document.getElementById('bracket').classList.contains('show') && window.jQuery && $.fn && $.fn.bracket) {
                                $('#bracket-container').empty().bracket({ init: tournamentData.bracketData });
                            }
                        }
                    }
                }
                // If modal is open for this match, refresh view
                if (currentMatch && currentMatch.id === matchId) {
                    Object.assign(currentMatch, payload);
                    const pitchType = tournamentData.pitchType || '7';
                    const positions = PITCH_CONFIGS[pitchType] || PITCH_CONFIGS['7'];
                    renderTeamLineup('team1', currentMatch.team1, currentMatch.lineup1 || [], positions);
                    renderTeamLineup('team2', currentMatch.team2, currentMatch.lineup2 || [], positions);
                    renderEvents();
                }
            });
        }
        let currentMatchId = null;
        let currentMatch = null;
        let editingLocked = false;
        let matchModalInstance = null;

        // Load Approved Teams from API
        function loadApprovedTeams() {
            const listContainer = document.getElementById('approvedTeamsList');
            if(!listContainer) return;
            
            listContainer.innerHTML = '<div class="text-center p-3">Đang tải danh sách...</div>';
            
            fetch('/admin/team-registration/api/approved')
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        if(data.teams.length === 0) {
                            listContainer.innerHTML = '<div class="text-center p-3">Chưa có đội nào được duyệt. Hãy vào menu "Hồ Sơ Đội Tuyển" để duyệt.</div>';
                            return;
                        }
                        
                        let html = '';
                        data.teams.forEach(team => {
                            html += `
                                <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" 
                                    onclick="selectApprovedTeam('${team._id}', '${team.teamName}')">
                                    <img src="/static/images/${team.logo}" style="width: 40px; height: 40px; object-fit: cover;" class="rounded-circle me-3">
                                    <div>
                                        <h6 class="mb-0">${team.teamName}</h6>
                                        <small class="text-muted">${team.members.length} thành viên - ${team.representative}</small>
                                    </div>
                                </button>
                            `;
                        });
                        listContainer.innerHTML = html;
                    } else {
                        listContainer.innerHTML = '<div class="text-danger p-3">Lỗi tải dữ liệu</div>';
                    }
                })
                .catch(err => {
                    console.error(err);
                    listContainer.innerHTML = '<div class="text-danger p-3">Lỗi kết nối</div>';
                });
        }

        function selectApprovedTeam(id, name) {
            document.getElementById('selectedRegistrationId').value = id;
            document.getElementById('selectedTeamName').innerText = name;
            document.getElementById('approvedTeamsList').classList.add('d-none');
            document.getElementById('importTeamForm').classList.remove('d-none');
            document.getElementById('importTeamForm').classList.add('d-block');
        }

        // Ensure overlay spinner is hidden to avoid blocking clicks
        document.addEventListener('DOMContentLoaded', function(){
            const sp = document.getElementById('spinner');
            if (sp) sp.classList.remove('show');
        });

        // Defensive: delegate clicks for all buttons that have data-match-id
        document.addEventListener('click', function(e){
            const btn = e.target.closest('button[data-match-id]');
            if (btn) {
                e.preventDefault();
                const mid = btn.getAttribute('data-match-id');
                if (mid) openMatchDetail(mid);
            }
        });

        // Position Configs (Simple approximations)
        const PITCH_CONFIGS = {
            '5': [
                {role: 'GK', top: '90%', left: '50%'},
                {role: 'DF', top: '70%', left: '30%'}, {role: 'DF', top: '70%', left: '70%'},
                {role: 'FW', top: '30%', left: '30%'}, {role: 'FW', top: '30%', left: '70%'}
            ],
            '7': [
                {role: 'GK', top: '90%', left: '50%'},
                {role: 'CD', top: '75%', left: '50%'},
                {role: 'LM', top: '50%', left: '15%'}, {role: 'RM', top: '50%', left: '85%'}, {role: 'CM', top: '50%', left: '50%'},
                {role: 'FW', top: '25%', left: '35%'}, {role: 'FW', top: '25%', left: '65%'}
            ]
        };

        function openMatchDetail(matchId) {
            currentMatchId = matchId;
            currentMatch = null;

            // Find match
            if (tournamentData.fixtures) {
                for (const group of tournamentData.fixtures) {
                    const m = group.matches.find(m => m.id === matchId);
                    if (m) {
                        currentMatch = m;
                        break;
                    }
                }
            }

            if (!currentMatch) return alert('Match not found!');

            // Populate Header
            document.getElementById('matchTeam1Name').innerText = currentMatch.team1;
            document.getElementById('matchTeam2Name').innerText = currentMatch.team2;
            document.getElementById('matchScore1').value = currentMatch.score1;
            document.getElementById('matchScore2').value = currentMatch.score2;

            editingLocked = (currentMatch.score1 !== null && currentMatch.score1 !== undefined) && (currentMatch.score2 !== null && currentMatch.score2 !== undefined);
            applyEditingLockUI();

            // Render Lineups
            const pitchType = tournamentData.pitchType || '7'; // Default to 7
            const positions = PITCH_CONFIGS[pitchType] || PITCH_CONFIGS['7'];

            renderTeamLineup('team1', currentMatch.team1, currentMatch.lineup1 || [], positions);
            renderTeamLineup('team2', currentMatch.team2, currentMatch.lineup2 || [], positions);

            // Show Modal
            const modalEl = document.getElementById('matchDetailModal');
            if (!matchModalInstance) {
                matchModalInstance = new bootstrap.Modal(modalEl, { backdrop: 'static' });
            }
            matchModalInstance.show();
        }
        window.openMatchDetail = openMatchDetail;

        function applyEditingLockUI() {
            const score1El = document.getElementById('matchScore1');
            const score2El = document.getElementById('matchScore2');
            const controls = [
                document.getElementById('eventTeamSelect'),
                document.getElementById('eventMinute'),
                document.getElementById('eventTypeSelect'),
                document.getElementById('eventPlayerSelect'),
                document.getElementById('assistPlayerSelect')
            ];
            const addBtn = document.querySelector('#matchDetailModal button.btn.btn-success');
            if (editingLocked) {
                score1El && score1El.setAttribute('disabled','disabled');
                score2El && score2El.setAttribute('disabled','disabled');
                controls.forEach(c=>{ if (c) c.setAttribute('disabled','disabled'); });
                if (addBtn) addBtn.setAttribute('disabled','disabled');
            } else {
                score1El && score1El.removeAttribute('disabled');
                score2El && score2El.removeAttribute('disabled');
                controls.forEach(c=>{ if (c) c.removeAttribute('disabled'); });
                if (addBtn) addBtn.removeAttribute('disabled');
            }
        }

        function renderTeamLineup(side, teamName, currentLineup, positions) {
            const team = tournamentData.teams.find(t => t.name === teamName);
            const members = team ? (team.members || []) : [];
            
            const pitchContainer = document.getElementById(`pitch-${side}`);
            const subsContainer = document.getElementById(`subs-${side}`);
            
            pitchContainer.innerHTML = '';
            subsContainer.innerHTML = '';

            // 1. Render Pitch Positions
            positions.forEach((pos, index) => {
                const posDiv = document.createElement('div');
                posDiv.className = 'player-position';
                posDiv.style.top = pos.top;
                posDiv.style.left = pos.left;
                posDiv.setAttribute('data-role', pos.role);
                posDiv.setAttribute('data-index', index);
                if (!editingLocked) {
                    posDiv.ondrop = (e) => drop(e, side);
                    posDiv.ondragover = allowDrop;
                }

                // Check if player is assigned
                const assignedPlayerId = currentLineup[index];
                const player = assignedPlayerId ? members.find(m => m.id === assignedPlayerId || m.name === assignedPlayerId) : null;

                if (player) {
                    const status = getPlayerDisciplinaryStatus(player, side);
                    const stats = getPlayerEventStats(player, side);
                    const sentOffClass = status.sentOff ? 'opacity:0.5; filter: grayscale(100%);' : '';
                    
                    // Badges HTML
                    let badgesHtml = '';
                    if (stats.goals > 0) {
                        badgesHtml += `<div class="badge-goal" title="Bàn thắng"><i class="fa fa-futbol"></i> ${stats.goals}</div>`;
                    }
                    if (stats.assists > 0) {
                        badgesHtml += `<div class="badge-assist" title="Kiến tạo"><span class="badge-assist-icon">A</span> ${stats.assists}</div>`;
                    }
                    if (status.yellow > 0) {
                        // Show yellow card icon
                        badgesHtml += `<div style="width:12px; height:16px; background:#ffc107; border-radius:2px; border:1px solid #fff; margin-bottom:1px; box-shadow:0 1px 2px rgba(0,0,0,0.3);"></div>`;
                        if (status.yellow > 1) {
                             // Second yellow (conceptually handled by red logic usually, but let's show 2 cards if needed or just rely on sentOff)
                             badgesHtml += `<div style="width:12px; height:16px; background:#ffc107; border-radius:2px; border:1px solid #fff; margin-bottom:1px; position:absolute; top:2px; left:2px; box-shadow:0 1px 2px rgba(0,0,0,0.3);"></div>`;
                        }
                    }
                    if (status.red > 0) {
                        badgesHtml += `<div style="width:12px; height:16px; background:#dc3545; border-radius:2px; border:1px solid #fff; margin-bottom:1px; box-shadow:0 1px 2px rgba(0,0,0,0.3);"></div>`;
                    }

                    const draggableAttr = (!editingLocked) ? `draggable="true" ondragstart="drag(event, '${player.id || player.name}', '${side}', 'field', ${index})"` : '';
                    posDiv.innerHTML = `
                        <div class="position-label">${pos.role}</div>
                        <div style="position: relative; display: inline-block;">
                            <div class="player-avatar" style="${sentOffClass}" ${draggableAttr}>
                                ${player.avatar && player.avatar !== 'default-avatar.png' ? 
                                    `<img src="/static/uploads/tournaments/${player.avatar}">` : 
                                    `<i class="fa fa-user text-secondary"></i>`}
                            </div>
                            <!-- Status Container: Top Right overlapping -->
                            <div style="position:absolute; top:-8px; right:-12px; display:flex; flex-direction:column; align-items:center; z-index:100;">
                                ${badgesHtml}
                            </div>
                        </div>
                        <div class="player-name">${player.name}</div>
                    `;
                } else {
                    posDiv.innerHTML = `
                        <div class="position-label">${pos.role}</div>
                        <div class="player-avatar bg-transparent border-dashed" style="border-style: dashed; opacity: 0.5;">
                            <i class="fa fa-plus text-white"></i>
                        </div>
                        <div class="player-name bg-transparent text-white-50">Trống</div>
                    `;
                }
                pitchContainer.appendChild(posDiv);
            });

            // 2. Render Subs (Everyone not in lineup)
            members.forEach(member => {
                // Check if member is in lineup (by ID or Name fallback)
                const isInLineup = currentLineup.includes(member.id) || currentLineup.includes(member.name);
                
                if (!isInLineup) {
                    const status = getPlayerDisciplinaryStatus(member, side);
                    const stats = getPlayerEventStats(member, side);
                    const sentOffClass = status.sentOff ? 'opacity:0.5; filter: grayscale(100%);' : '';

                    // Badges HTML for Subs
                    let badgesHtml = '';
                    if (stats.goals > 0) badgesHtml += `<div class="badge-goal" title="Bàn thắng"><i class="fa fa-futbol"></i> ${stats.goals}</div>`;
                    if (stats.assists > 0) badgesHtml += `<div class="badge-assist" title="Kiến tạo"><span class="badge-assist-icon">A</span> ${stats.assists}</div>`;
                    if (status.yellow > 0) badgesHtml += `<div style="width:12px; height:16px; background:#ffc107; border-radius:2px; border:1px solid #fff; margin-bottom:1px; box-shadow:0 1px 2px rgba(0,0,0,0.3);"></div>`;
                    if (status.red > 0) badgesHtml += `<div style="width:12px; height:16px; background:#dc3545; border-radius:2px; border:1px solid #fff; margin-bottom:1px; box-shadow:0 1px 2px rgba(0,0,0,0.3);"></div>`;

                    const subDiv = document.createElement('div');
                    subDiv.className = 'sub-player';
                    if (!editingLocked) {
                        subDiv.draggable = true;
                        subDiv.ondragstart = (e) => drag(e, member.id || member.name, side, 'sub');
                    }
                    subDiv.innerHTML = `
                        <div style="position: relative; display: inline-block;">
                            <div class="player-avatar" style="${sentOffClass}">
                                ${member.avatar && member.avatar !== 'default-avatar.png' ? 
                                    `<img src="/static/uploads/tournaments/${member.avatar}">` : 
                                    `<div class="bg-secondary w-100 h-100 d-flex align-items-center justify-content-center text-white"><i class="fa fa-user"></i></div>`}
                            </div>
                            <div style="position:absolute; top:-8px; right:-12px; display:flex; flex-direction:column; align-items:center; z-index:100;">
                                ${badgesHtml}
                            </div>
                        </div>
                        <div class="player-name">${member.name}</div>
                    `;
                    subsContainer.appendChild(subDiv);
                }
            });
        }

        // Drag & Drop Logic
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev, playerId, side, source, index) {
            ev.dataTransfer.setData("playerId", playerId);
            ev.dataTransfer.setData("side", side);
            ev.dataTransfer.setData("source", source); // 'field' or 'sub'
            if (index !== undefined) ev.dataTransfer.setData("index", index);
        }

        function drop(ev, targetSide) {
            ev.preventDefault();
            const playerId = ev.dataTransfer.getData("playerId");
            const side = ev.dataTransfer.getData("side");
            
            // Prevent cross-team transfers
            // targetSide might be undefined if dropped on subs container directly, need to infer
            if (!targetSide) {
                // Check parent id
                let p = ev.target;
                while(p && !p.id.startsWith('subs-') && !p.id.startsWith('pitch-')) {
                    p = p.parentElement;
                }
                if (p) targetSide = p.id.split('-')[1];
            }

            if (side !== targetSide) return;

            // Determine Target Type (Field Position or Subs)
            let target = ev.target;
            let targetType = 'sub';
            let targetIndex = -1;

            // Traverse up to find position container
            let posDiv = target.closest('.player-position');
            if (posDiv) {
                targetType = 'field';
                targetIndex = parseInt(posDiv.getAttribute('data-index'));
            }

            // Update Data
            const lineupKey = side === 'team1' ? 'lineup1' : 'lineup2';
            if (!currentMatch[lineupKey]) currentMatch[lineupKey] = [];
            
            // Ensure lineup array is big enough
            const pitchType = tournamentData.pitchType || '7';
            const size = (PITCH_CONFIGS[pitchType] || PITCH_CONFIGS['7']).length;
            while(currentMatch[lineupKey].length < size) currentMatch[lineupKey].push(null);

            const source = ev.dataTransfer.getData("source");
            const sourceIndex = parseInt(ev.dataTransfer.getData("index"));

            if (targetType === 'field') {
                // Moving to Field
                
                // If moving from another field position, clear old one
                if (source === 'field') {
                    currentMatch[lineupKey][sourceIndex] = null;
                }

                // If target has a player, move them to subs (implicitly handled by render) or swap?
                // For simplicity: Overwrite (rendering will put displaced player in subs)
                // Actually, swap is better UX, but harder. Let's just Overwrite/Swap if from field.
                
                if (source === 'field') {
                    // Swap
                    const existingPlayer = currentMatch[lineupKey][targetIndex];
                    currentMatch[lineupKey][targetIndex] = playerId;
                    currentMatch[lineupKey][sourceIndex] = existingPlayer; 
                } else {
                    // From Subs: Just place. Old player at target goes to subs.
                    currentMatch[lineupKey][targetIndex] = playerId;
                }

            } else {
                // Moving to Subs
                if (source === 'field') {
                    currentMatch[lineupKey][sourceIndex] = null;
                }
            }

            // Re-render
            const pitchConfig = PITCH_CONFIGS[pitchType] || PITCH_CONFIGS['7'];
            const teamName = side === 'team1' ? currentMatch.team1 : currentMatch.team2;
            renderTeamLineup(side, teamName, currentMatch[lineupKey], pitchConfig);
        }

        function saveLineupOnly(event) {
            if (event) event.preventDefault();
            if (!currentMatch) return;
            const data = {
                tournamentId: tournamentData._id,
                matchId: currentMatch.id,
                lineup1: currentMatch.lineup1,
                lineup2: currentMatch.lineup2
            };

            const btn = event && event.currentTarget ? event.currentTarget : document.querySelector('#matchDetailModal .btn-outline-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Đang lưu đội hình...';

            fetch('/admin/football/tournament/update-match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json().catch(() => ({})))
            .then(res => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                if (res && res.success) {
                    // Sync with global tournamentData to ensure persistence across modal close/reopen
                    if (tournamentData.fixtures) {
                        for (const group of tournamentData.fixtures) {
                            const m = group.matches.find(m => m.id === currentMatch.id);
                            if (m) {
                                m.lineup1 = currentMatch.lineup1;
                                m.lineup2 = currentMatch.lineup2;
                            }
                        }
                    }

                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show m-3';
                    alertDiv.innerHTML = 'Đã lưu đội hình ra sân.';
                    document.querySelector('#matchDetailModal .modal-body').prepend(alertDiv);
                    setTimeout(()=>{ alertDiv.remove(); }, 2000);
                } else {
                     alert('Lỗi khi lưu: ' + (res.message || 'Không xác định'));
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert('Lỗi kết nối: ' + err.message);
            });
        }

        function saveEventsOnly(event) {
            if (event) event.preventDefault();
            if (!currentMatch) return;
            const data = {
                tournamentId: tournamentData._id,
                matchId: currentMatch.id,
                events: currentMatch.events || [],
                status: 'live'
            };

            const btn = event && event.currentTarget ? event.currentTarget : document.querySelector('#matchDetailModal .btn-outline-success');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Đang lưu diễn biến...';

            fetch('/admin/football/tournament/update-match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json().catch(() => ({})))
            .then(res => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                if (res && res.success) {
                    if (tournamentData.fixtures) {
                        for (const group of tournamentData.fixtures) {
                            const m = group.matches.find(m => m.id === currentMatch.id);
                            if (m) {
                                m.events = currentMatch.events || [];
                                m.status = 'live';
                            }
                        }
                    }
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show m-3';
                    alertDiv.innerHTML = 'Đã lưu diễn biến trận đấu.';
                    document.querySelector('#matchDetailModal .modal-body').prepend(alertDiv);
                    setTimeout(()=>{ alertDiv.remove(); }, 2000);
                } else {
                    alert('Lỗi khi lưu: ' + (res.message || 'Không xác định'));
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert('Lỗi kết nối: ' + err.message);
            });
        }

        function finishMatch(event) {
            if (event) event.preventDefault();
            if (!currentMatch) return;

            const score1 = document.getElementById('matchScore1').value;
            const score2 = document.getElementById('matchScore2').value;

            const data = {
                tournamentId: tournamentData._id,
                matchId: currentMatch.id,
                score1: score1,
                score2: score2,
                lineup1: currentMatch.lineup1,
                lineup2: currentMatch.lineup2,
                events: currentMatch.events || []
            };

            const btn = event && event.currentTarget ? event.currentTarget : document.querySelector('#matchDetailModal .btn-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Đang kết thúc...';

            fetch('/admin/football/tournament/update-match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json().catch(() => ({})))
            .then(res => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                if (res && res.success) {
                    currentMatch.score1 = score1;
                    currentMatch.score2 = score2;

                    if (tournamentData.fixtures) {
                        for (const group of tournamentData.fixtures) {
                            const m = group.matches.find(m => m.id === currentMatch.id);
                            if (m) {
                                m.score1 = score1;
                                m.score2 = score2;
                                m.lineup1 = currentMatch.lineup1;
                                m.lineup2 = currentMatch.lineup2;
                                m.events = currentMatch.events;
                            }
                        }
                    }

                    editingLocked = true;
                    applyEditingLockUI();
                    const pitchType = tournamentData.pitchType || '7';
                    const positions = PITCH_CONFIGS[pitchType] || PITCH_CONFIGS['7'];
                    renderTeamLineup('team1', currentMatch.team1, currentMatch.lineup1 || [], positions);
                    renderTeamLineup('team2', currentMatch.team2, currentMatch.lineup2 || [], positions);

                    const triggerBtn = document.querySelector(`[data-match-id="${currentMatch.id}"]`);
                    if (triggerBtn) {
                        const row = triggerBtn.closest('tr');
                        if (row) {
                            const scoreCell = row.querySelector('td.text-center');
                            if (scoreCell) scoreCell.innerHTML = `${score1} : ${score2}`;
                            const statusCell = row.querySelector('td .badge');
                            if (statusCell) {
                                statusCell.className = 'badge bg-success';
                                statusCell.innerText = 'Hoàn thành';
                            }
                        }
                    }

                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show m-3';
                    alertDiv.innerHTML = 'Trận đấu đã kết thúc. Mọi chỉnh sửa đã bị khóa.';
                    document.querySelector('#matchDetailModal .modal-body').prepend(alertDiv);
                    setTimeout(()=>{ alertDiv.remove(); }, 2500);
                } else {
                     alert('Lỗi khi kết thúc: ' + (res.message || 'Không xác định'));
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert('Lỗi kết nối: ' + err.message);
            });
        }

        // Events logic
        function getActivePlayers(side) {
            const lineupKey = side === 'team1' ? 'lineup1' : 'lineup2';
            const teamName = side === 'team1' ? currentMatch.team1 : currentMatch.team2;
            const team = tournamentData.teams.find(t => t.name === teamName);
            const members = team ? (team.members || []) : [];
            const ids = (currentMatch[lineupKey] || []).filter(Boolean);
            return members.filter(m => ids.includes(m.id) || ids.includes(m.name));
        }

        function getBenchPlayers(side) {
            const teamName = side === 'team1' ? currentMatch.team1 : currentMatch.team2;
            const team = tournamentData.teams.find(t => t.name === teamName);
            const members = team ? (team.members || []) : [];
            const active = getActivePlayers(side);
            const activeIds = new Set(active.map(m => m.id));
            return members.filter(m => !activeIds.has(m.id));
        }

        function updateEventForm() {
            const side = document.getElementById('eventTeamSelect').value;
            const type = document.getElementById('eventTypeSelect').value;
            const playerSelect = document.getElementById('eventPlayerSelect');
            const assistSelect = document.getElementById('assistPlayerSelect');
            const assistContainer = document.getElementById('assistContainer');

            const active = getActivePlayers(side);
            const bench = getBenchPlayers(side);

            let selectable = active;
            if (type === 'yellow' || type === 'red') {
                selectable = active.concat(bench);
            }

            // Filter out players who are sent off (Red card or 2 Yellows)
            selectable = selectable.filter(p => {
                const status = getPlayerDisciplinaryStatus(p, side);
                return !status.sentOff;
            });

            playerSelect.innerHTML = selectable.map(p => `<option value="${p.id || p.name}">${p.name}</option>`).join('');

            if (type === 'goal') {
                assistContainer.style.display = '';
                // Filter assist candidates: must not be sent off, and not the scorer
                let assistCandidates = active.filter(p => {
                    const status = getPlayerDisciplinaryStatus(p, side);
                    return !status.sentOff && (p.id || p.name) !== playerSelect.value;
                });
                
                const options = [`<option value="">Không</option>`].concat(
                    assistCandidates.map(p => `<option value="${p.id || p.name}">${p.name}</option>`)
                );
                assistSelect.innerHTML = options.join('');
            } else {
                assistContainer.style.display = 'none';
                assistSelect.innerHTML = '';
            }
        }

        document.getElementById('eventTeamSelect').addEventListener('change', updateEventForm);
        document.getElementById('eventTypeSelect').addEventListener('change', updateEventForm);
        document.getElementById('eventPlayerSelect').addEventListener('change', function(){
            const type = document.getElementById('eventTypeSelect').value;
            if (type !== 'goal') return;
            const side = document.getElementById('eventTeamSelect').value;
            const active = getActivePlayers(side);
            const playerId = document.getElementById('eventPlayerSelect').value;
            const assistSelect = document.getElementById('assistPlayerSelect');
            
            // Filter assist candidates on player change too
            let assistCandidates = active.filter(p => {
                const status = getPlayerDisciplinaryStatus(p, side);
                return !status.sentOff && String(p.id || p.name) !== String(playerId);
            });

            assistSelect.innerHTML = [`<option value="">Không</option>`].concat(
                assistCandidates.map(p => `<option value="${p.id || p.name}">${p.name}</option>`)
            ).join('');
        });

        function addEvent() {
            if (!currentMatch.events) currentMatch.events = [];
            const minute = parseInt(document.getElementById('eventMinute').value || '0');
            const side = document.getElementById('eventTeamSelect').value;
            const type = document.getElementById('eventTypeSelect').value;
            const playerId = document.getElementById('eventPlayerSelect').value;
            const assistRaw = document.getElementById('assistPlayerSelect').value;
            const assistId = assistRaw === '' ? null : assistRaw;

            const teamName = side === 'team1' ? currentMatch.team1 : currentMatch.team2;
            const team = tournamentData.teams.find(t => t.name === teamName);
            const members = team ? (team.members || []) : [];
            const player = members.find(m => String(m.id) === String(playerId) || m.name === playerId);
            const assist = members.find(m => String(m.id) === String(assistId) || m.name === assistId);

            const ev = {
                id: Date.now() + '_' + Math.random().toString(36).substr(2,5),
                minute,
                team: side,
                teamName,
                playerId: player ? player.id : null,
                playerName: player ? player.name : 'N/A',
                type,
                assistId: assist ? assist.id : null,
                assistName: assist ? assist.name : ''
            };

            currentMatch.events.push(ev);
            renderEvents();
            recomputeScoreFromEvents();
            renderTeamLineup('team1', currentMatch.team1, currentMatch.lineup1 || [], PITCH_CONFIGS[tournamentData.pitchType || '7'] || PITCH_CONFIGS['7']);
            renderTeamLineup('team2', currentMatch.team2, currentMatch.lineup2 || [], PITCH_CONFIGS[tournamentData.pitchType || '7'] || PITCH_CONFIGS['7']);
        }

        function renderEvents() {
            const body = document.getElementById('eventListBody');
            body.innerHTML = '';
            if (!currentMatch.events || currentMatch.events.length === 0) {
                body.innerHTML = '<tr class="text-center text-muted"><td colspan="6">Chưa có diễn biến nào</td></tr>';
                return;
            }
            currentMatch.events.sort((a,b)=>a.minute-b.minute).forEach(ev=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">${ev.minute}</td>
                    <td>${ev.team === 'team1' ? currentMatch.team1 : currentMatch.team2}</td>
                    <td>${ev.playerName}</td>
                    <td class="text-center">${ev.type === 'goal' ? 'Bàn thắng' : ev.type === 'yellow' ? 'Thẻ vàng' : 'Thẻ đỏ'}</td>
                    <td>${ev.assistName || ''}</td>
                    <td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="removeEvent('${ev.id}')"><i class="fa fa-trash"></i></button></td>
                `;
                body.appendChild(tr);
            });
        }

        function removeEvent(id) {
            if (!currentMatch.events) return;
            currentMatch.events = currentMatch.events.filter(e => e.id !== id);
            renderEvents();
            recomputeScoreFromEvents();
            renderTeamLineup('team1', currentMatch.team1, currentMatch.lineup1 || [], PITCH_CONFIGS[tournamentData.pitchType || '7'] || PITCH_CONFIGS['7']);
            renderTeamLineup('team2', currentMatch.team2, currentMatch.lineup2 || [], PITCH_CONFIGS[tournamentData.pitchType || '7'] || PITCH_CONFIGS['7']);
        }

        function recomputeScoreFromEvents() {
            let s1 = 0, s2 = 0;
            (currentMatch.events || []).forEach(ev=>{
                if (ev.type === 'goal') {
                    if (ev.team === 'team1') s1++; else s2++;
                }
            });
            document.getElementById('matchScore1').value = s1;
            document.getElementById('matchScore2').value = s2;
        }

        function getPlayerDisciplinaryStatus(player, side) {
            const events = currentMatch && currentMatch.events ? currentMatch.events : [];
            let yellow = 0, red = 0;
            events.forEach(ev => {
                let isTarget = false;
                // Robust check: ID match OR (Name match AND (No ID in event OR No ID in player))
                if (ev.playerId && player.id && String(ev.playerId) === String(player.id)) {
                    isTarget = true;
                } else if (ev.playerName === player.name) {
                    // Fallback to name if one side lacks ID
                    if (!ev.playerId || !player.id) isTarget = true;
                }

                if (isTarget) {
                    if (ev.type === 'yellow') yellow++;
                    if (ev.type === 'red') red++;
                }
            });
            const sentOff = red >= 1 || yellow >= 2;
            return { yellow, red, sentOff };
        }

        function getPlayerEventStats(player, side) {
            const events = currentMatch && currentMatch.events ? currentMatch.events : [];
            let goals = 0, assists = 0;
            events.forEach(ev => {
                let isTarget = false;
                // Robust check: ID match OR (Name match AND (No ID in event OR No ID in player))
                if (ev.playerId && player.id && String(ev.playerId) === String(player.id)) {
                    isTarget = true;
                } else if (ev.playerName === player.name) {
                    // Fallback to name if one side lacks ID
                    if (!ev.playerId || !player.id) isTarget = true;
                }

                if (isTarget) {
                    if (ev.type === 'goal') goals++;
                }

                // Assist check
                let isAssist = false;
                if (ev.assistId && player.id && String(ev.assistId) === String(player.id)) {
                    isAssist = true;
                } else if (ev.assistName === player.name) {
                     if (!ev.assistId || !player.id) isAssist = true;
                }

                if (isAssist && ev.type === 'goal') {
                    assists++;
                }
            });
            return { goals, assists };
        }

        // Initialize event form when modal opens
        document.getElementById('matchDetailModal').addEventListener('shown.bs.modal', function(){
            document.getElementById('eventTeamSelect').value = 'team1';
            document.getElementById('eventTypeSelect').value = 'goal';
            const teamSelect = document.getElementById('eventTeamSelect');
            teamSelect.options[0].text = currentMatch.team1;
            teamSelect.options[1].text = currentMatch.team2;
            updateEventForm();
            renderEvents();
        });

        document.getElementById('matchDetailModal').addEventListener('hidden.bs.modal', function(){
            // Defensive cleanup to avoid dimmed overlay staying
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');
            document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
            matchModalInstance && matchModalInstance.dispose && matchModalInstance.dispose();
            matchModalInstance = null;
        });

        function submitAddMember(btn) {
            const form = btn.closest('form');
            if (!form) {
                return;
            }

            const formData = new FormData(form);
            const teamId = form.getAttribute('data-team-id');
            
            if (!teamId) {
                alert('Lỗi: Không tìm thấy ID đội bóng. Vui lòng tải lại trang.');
                return;
            }

            const memberNameInput = form.querySelector('input[name="memberName"]');
            if (!memberNameInput || !memberNameInput.value.trim()) {
                alert('Vui lòng nhập tên thành viên!');
                if(memberNameInput) memberNameInput.focus();
                return;
            }

            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang thêm...';

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(async response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.message || 'Server Error');
                    }
                    return data;
                } else {
                    const text = await response.text();
                    throw new Error('Server returned non-JSON response');
                }
            })
            .then(data => {
                if (data.success) {
                    // Reset inputs
                    form.querySelector('input[name="memberName"]').value = '';
                    form.querySelector('input[name="memberAvatar"]').value = '';
                    
                    // Update list
                    const list = document.getElementById(`member-list-${teamId}`);
                    const countSpan = document.getElementById(`member-count-${teamId}`);
                    
                    const member = data.member;
                    
                    // Check if the list only contains the "no members" item
                    const emptyMsg = list.querySelector('.text-muted');
                    let index = 1;
                    if (emptyMsg) {
                        emptyMsg.remove();
                    } else {
                        index = list.children.length + 1;
                    }
                    
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="fw-bold me-3">${index}.</span>
                            ${member.avatar && member.avatar !== 'default-avatar.png' ? 
                                `<img src="/static/uploads/tournaments/${member.avatar}" class="rounded-circle me-2" width="30" height="30">` : 
                                `<div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center text-white" style="width: 30px; height: 30px;"><i class="fa fa-user"></i></div>`
                            }
                            <span>${member.name}</span>
                        </div>
                    `;
                    
                    list.appendChild(li);
                    
                    // Update count
                    if (countSpan) {
                        countSpan.innerText = parseInt(countSpan.innerText) + 1;
                    }
                    
                    // Focus back to name input
                    memberNameInput.focus();
                } else {
                    alert('Lỗi: ' + (data.message || 'Không thể thêm thành viên'));
                }
            })
            .catch(err => {
                alert('Đã xảy ra lỗi: ' + err.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            });
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            let data = (tournamentData && tournamentData.bracketData) ? tournamentData.bracketData : null;
            const ready = !!(data && data.teams && data.results && window.jQuery && $.fn && $.fn.bracket);
            function render(){ if (!ready) return; $('#bracket-container').empty().bracket({ init: data }); }
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(function(btn){
                btn.addEventListener('shown.bs.tab', function(e){ if (e.target.id === 'bracket-tab') render(); });
            });
            if (document.getElementById('bracket') && document.getElementById('bracket').classList.contains('show')) render();
            if (!ready) {
                const msg = (!$.fn || !$.fn.bracket) ? 'Thiếu thư viện bracket.' : 'Chưa có dữ liệu sơ đồ.';
                const el = document.getElementById('bracket-container');
                if (el && !el.innerHTML.trim()) el.innerHTML = '<p class="text-muted">' + msg + '</p>';
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const raw = '<%- encodeURIComponent(JSON.stringify(tournament.bracketData || null)) %>';
            let data = null;
            try { data = JSON.parse(decodeURIComponent(raw)); } catch(_) { data = null; }
            const ready = !!(data && data.teams && data.results && window.jQuery && $.fn && $.fn.bracket);
            function render(){ if (!ready) return; $('#bracket-container').empty().bracket({ init: data }); }
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(function(btn){
                btn.addEventListener('shown.bs.tab', function(e){ if (e.target.id === 'bracket-tab') render(); });
            });
            if (document.getElementById('bracket') && document.getElementById('bracket').classList.contains('show')) render();
            if (!ready) {
                const msg = (!$.fn || !$.fn.bracket) ? 'Thiếu thư viện bracket.' : 'Chưa có dữ liệu sơ đồ.';
                const el = document.getElementById('bracket-container');
                if (el && !el.innerHTML.trim()) el.innerHTML = '<p class="text-muted">' + msg + '</p>';
            }
        });
    </script>
</body>

</html>
