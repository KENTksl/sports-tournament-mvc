<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partical/headercomponent'); %>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-bracket/0.11.1/jquery.bracket.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-bracket/0.11.1/jquery.bracket.min.css" />
    <style>
        .jQBracket .team { color: #333; }
        .jQBracket .score { color: #333; }
    </style>
</head>

<body>
    <div class="container-fluid position-relative bg-white d-flex p-0">
        <!-- Spinner Start -->
        <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->

        <!-- Sidebar Start -->
        <%- include('../partical/menucomponent'); %>
        <!-- Sidebar End -->

        <!-- Content Start -->
        <div class="content">
            <!-- Navbar Start -->
            <%- include('../partical/navbarcomponent'); %>
            <!-- Navbar End -->

            <!-- Detail Start -->
            <div class="container-fluid pt-4 px-4">
                <div class="bg-light rounded h-100 p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h6 class="mb-0">Chi Tiết Giải Đấu: <%= tournament.name %></h6>
                        <a href="/admin/football/tournament" class="btn btn-secondary">Quay Lại</a>
                    </div>

                    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Thông Tin Chung</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button" role="tab">Danh Sách Đội</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="fixtures-tab" data-bs-toggle="tab" data-bs-target="#fixtures" type="button" role="tab">Lịch Thi Đấu</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="bracket-tab" data-bs-toggle="tab" data-bs-target="#bracket" type="button" role="tab">Sơ Đồ Thi Đấu</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="myTabContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Ban Tổ Chức:</strong> <%= tournament.organizer %></p>
                                    <p><strong>Chế Độ:</strong> <%= tournament.mode %></p>
                                    <p><strong>Số Đội:</strong> <%= tournament.teams ? tournament.teams.length : 0 %> / <%= tournament.teamsCount %></p>
                                    <p><strong>Trạng Thái:</strong> <%= tournament.status %></p>
                                    <p><strong>Mô Tả:</strong> <%= tournament.description %></p>
                                </div>
                                <div class="col-md-6">
                                    <% if (tournament.image && tournament.image !== 'default.png') { %>
                                        <img src="/static/uploads/tournaments/<%= tournament.image %>" class="img-fluid rounded" alt="Tournament Image">
                                    <% } %>
                                </div>
                            </div>
                        </div>

                        <!-- Teams Tab -->
                        <div class="tab-pane fade" id="teams" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeamModal">Thêm Đội</button>
                            </div>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tên Đội</th>
                                        <th>Thành Viên</th>
                                        <th>Thống Kê (P/W/D/L/Pts)</th>
                                        <th>Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (tournament.teams && tournament.teams.length > 0) { %>
                                        <% tournament.teams.forEach((team, index) => { %>
                                            <tr>
                                                <td><%= index + 1 %></td>
                                                <td><%= team.name %></td>
                                                <td>
                                                    <%= team.members ? team.members.length : 0 %> thành viên
                                                </td>
                                                <td>
                                                    <%= team.stats.p %> / <%= team.stats.w %> / <%= team.stats.d %> / <%= team.stats.l %> / <strong><%= team.stats.pts %></strong>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editTeamModal<%= team.id %>">Sửa</button>
                                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#manageMembersModal<%= team.id %>">Thành Viên</button>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr><td colspan="5" class="text-center">Chưa có đội nào tham gia</td></tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>

                        <!-- Fixtures Tab -->
                        <div class="tab-pane fade" id="fixtures" role="tabpanel">
                            
                            <!-- Sub-Nav for Stages -->
                            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="pills-group-tab" data-bs-toggle="pill" data-bs-target="#pills-group" type="button" role="tab">Vòng Bảng</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="pills-semifinal-tab" data-bs-toggle="pill" data-bs-target="#pills-semifinal" type="button" role="tab">Bán Kết</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="pills-final-tab" data-bs-toggle="pill" data-bs-target="#pills-final" type="button" role="tab">Chung Kết</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="pills-tabContent">
                                <!-- Group Stage -->
                                <div class="tab-pane fade show active" id="pills-group" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">Danh sách trận đấu vòng bảng</h6>
                                        <form action="/admin/football/tournament/generate-bracket" method="POST" onsubmit="return confirm('Bạn có chắc chắn muốn kết thúc vòng bảng và tạo vòng đấu loại trực tiếp? Hành động này sẽ tạo ra các cặp đấu dựa trên BXH hiện tại.');">
                                            <input type="hidden" name="tournamentId" value="<%= tournament._id %>">
                                            <button type="submit" class="btn btn-success">
                                                <i class="bi bi-trophy"></i> Tạo Vòng Knockout
                                            </button>
                                        </form>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ngày/Giờ</th>
                                                    <th class="text-end">Đội 1</th>
                                                    <th class="text-center">Tỷ Số</th>
                                                    <th class="text-start">Đội 2</th>
                                                    <th>Trạng Thái</th>
                                                    <th>Hành Động</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (tournament.fixtures && tournament.fixtures.length > 0) { %>
                                                    <% let hasGroupMatches = false; %>
                                                    <% tournament.fixtures.forEach((group) => { %>
                                                        <% if (group.group !== 'Vòng Chung Kết') { %>
                                                            <% hasGroupMatches = true; %>
                                                            <tr class="table-secondary">
                                                                <td colspan="6" class="fw-bold text-uppercase"><%= group.group %></td>
                                                            </tr>
                                                            <% if (group.matches && group.matches.length > 0) { %>
                                                                <% group.matches.forEach((match) => { %>
                                                                    <tr>
                                                                        <td>
                                                                            <%= match.date %> <br>
                                                                            <small class="text-muted"><%= match.time %></small>
                                                                        </td>
                                                                        <td class="text-end fw-bold"><%= match.team1 %></td>
                                                                        <td class="text-center bg-light">
                                                                            <%= (match.score1 !== null && match.score1 !== undefined) ? match.score1 : '-' %> : <%= (match.score2 !== null && match.score2 !== undefined) ? match.score2 : '-' %>
                                                                        </td>
                                                                        <td class="text-start fw-bold"><%= match.team2 %></td>
                                                                        <td>
                                                                            <% if (match.score1 !== null && match.score1 !== undefined) { %>
                                                                                <span class="badge bg-success">Hoàn thành</span>
                                                                            <% } else { %>
                                                                                <span class="badge bg-warning text-dark">Sắp đá</span>
                                                                            <% } %>
                                                                        </td>
                                                                        <td>
                                                                            <button class="btn btn-sm btn-warning" onclick="openMatchDetail('<%= match.id %>')">Cập Nhật</button>
                                                                        </td>
                                                                    </tr>
                                                                <% }) %>
                                                            <% } else { %>
                                                                <tr><td colspan="6" class="text-center fst-italic">Chưa có trận đấu nào trong bảng này</td></tr>
                                                            <% } %>
                                                        <% } %>
                                                    <% }) %>
                                                    <% if (!hasGroupMatches) { %>
                                                        <tr><td colspan="6" class="text-center">Chưa có trận đấu vòng bảng nào.</td></tr>
                                                    <% } %>
                                                <% } else { %>
                                                    <tr><td colspan="6" class="text-center">Chưa có lịch thi đấu.</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Semifinal Tab -->
                                <div class="tab-pane fade" id="pills-semifinal" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ngày/Giờ</th>
                                                    <th class="text-end">Đội 1</th>
                                                    <th class="text-center">Tỷ Số</th>
                                                    <th class="text-start">Đội 2</th>
                                                    <th>Trạng Thái</th>
                                                    <th>Hành Động</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (tournament.fixtures && tournament.fixtures.length > 0) { %>
                                                    <% let hasSemiMatches = false; %>
                                                    <% tournament.fixtures.forEach((group) => { %>
                                                        <% if (group.group === 'Vòng Chung Kết') { %>
                                                            <% if (group.matches && group.matches.length > 0) { %>
                                                                <% group.matches.forEach((match) => { %>
                                                                    <% // Filter for Semifinal: stage 'Knockout' or date contains 'Bán Kết' %>
                                                                    <% if (match.stage === 'Knockout' || (match.date && match.date.includes('Bán Kết'))) { %>
                                                                        <% hasSemiMatches = true; %>
                                                                        <tr>
                                                                            <td>
                                                                                <%= match.date %> <br>
                                                                                <small class="text-muted"><%= match.time %></small>
                                                                            </td>
                                                                            <td class="text-end fw-bold"><%= match.team1 %></td>
                                                                            <td class="text-center bg-light">
                                                                                <%= (match.score1 !== null && match.score1 !== undefined) ? match.score1 : '-' %> : <%= (match.score2 !== null && match.score2 !== undefined) ? match.score2 : '-' %>
                                                                            </td>
                                                                            <td class="text-start fw-bold"><%= match.team2 %></td>
                                                                            <td>
                                                                                <% if (match.score1 !== null && match.score1 !== undefined) { %>
                                                                                    <span class="badge bg-success">Hoàn thành</span>
                                                                                <% } else { %>
                                                                                    <span class="badge bg-warning text-dark">Sắp đá</span>
                                                                                <% } %>
                                                                            </td>
                                                                            <td>
                                                                                <button class="btn btn-sm btn-warning" onclick="openMatchDetail('<%= match.id %>')">Cập Nhật</button>
                                                                            </td>
                                                                        </tr>
                                                                    <% } %>
                                                                <% }) %>
                                                            <% } %>
                                                        <% } %>
                                                    <% }) %>
                                                    <% if (!hasSemiMatches) { %>
                                                        <tr><td colspan="6" class="text-center fst-italic py-5">Chưa có trận Bán Kết nào.</td></tr>
                                                    <% } %>
                                                <% } else { %>
                                                    <tr><td colspan="6" class="text-center">Chưa có dữ liệu.</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Final Tab -->
                                <div class="tab-pane fade" id="pills-final" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ngày/Giờ</th>
                                                    <th class="text-end">Đội 1</th>
                                                    <th class="text-center">Tỷ Số</th>
                                                    <th class="text-start">Đội 2</th>
                                                    <th>Trạng Thái</th>
                                                    <th>Hành Động</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (tournament.fixtures && tournament.fixtures.length > 0) { %>
                                                    <% let hasFinalMatches = false; %>
                                                    <% tournament.fixtures.forEach((group) => { %>
                                                        <% if (group.group === 'Vòng Chung Kết') { %>
                                                            <% if (group.matches && group.matches.length > 0) { %>
                                                                <% group.matches.forEach((match) => { %>
                                                                    <% // Filter for Final/3rd: stage 'Final'/'ThirdPlace' or date contains 'Chung Kết'/'Hạng 3' %>
                                                                    <% if (match.stage === 'Final' || match.stage === 'ThirdPlace' || (match.date && (match.date.includes('Chung Kết') || match.date.includes('Hạng 3')))) { %>
                                                                        <% hasFinalMatches = true; %>
                                                                        <tr>
                                                                            <td>
                                                                                <%= match.date %> <br>
                                                                                <small class="text-muted"><%= match.time %></small>
                                                                            </td>
                                                                            <td class="text-end fw-bold"><%= match.team1 %></td>
                                                                            <td class="text-center bg-light">
                                                                                <%= (match.score1 !== null && match.score1 !== undefined) ? match.score1 : '-' %> : <%= (match.score2 !== null && match.score2 !== undefined) ? match.score2 : '-' %>
                                                                            </td>
                                                                            <td class="text-start fw-bold"><%= match.team2 %></td>
                                                                            <td>
                                                                                <% if (match.score1 !== null && match.score1 !== undefined) { %>
                                                                                    <span class="badge bg-success">Hoàn thành</span>
                                                                                <% } else { %>
                                                                                    <span class="badge bg-warning text-dark">Sắp đá</span>
                                                                                <% } %>
                                                                            </td>
                                                                            <td>
                                                                                <button class="btn btn-sm btn-warning" onclick="openMatchDetail('<%= match.id %>')">Cập Nhật</button>
                                                                            </td>
                                                                        </tr>
                                                                    <% } %>
                                                                <% }) %>
                                                            <% } %>
                                                        <% } %>
                                                    <% }) %>
                                                    <% if (!hasFinalMatches) { %>
                                                        <tr><td colspan="6" class="text-center fst-italic py-5">Chưa có trận Chung Kết nào.</td></tr>
                                                    <% } %>
                                                <% } else { %>
                                                    <tr><td colspan="6" class="text-center">Chưa có dữ liệu.</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bracket Tab -->
                        <div class="tab-pane fade" id="bracket" role="tabpanel">
                            <div class="bg-white p-3 rounded shadow-sm overflow-auto">
                                <h5 class="mb-3">Sơ Đồ Thi Đấu</h5>
                                <div id="bracket-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Detail End -->

            <!-- Footer Start -->
            <%- include('../partical/footercomponent'); %>
            <!-- Footer End -->
        </div>
        <!-- Content End -->

        <!-- Back to Top -->
        <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
    </div>

    <!-- MODALS SECTION (Outside main content) -->
    
    <!-- Add Team Modal (Static) -->
    <div class="modal fade" id="addTeamModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm Đội Bóng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/admin/football/tournament/add-team" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="tournamentId" value="<%= tournament._id %>">
                        <div class="mb-3">
                            <label class="form-label">Tên Đội</label>
                            <input type="text" class="form-control" name="teamName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Logo</label>
                            <input type="file" class="form-control" name="teamLogo" accept="image/*">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Thêm Đội</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Generated Team Modals -->
    <% if (tournament.teams && tournament.teams.length > 0) { %>
        <% tournament.teams.forEach((team) => { %>
            <!-- Edit Team Modal -->
            <div class="modal fade" id="editTeamModal<%= team.id %>" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Sửa Đội: <%= team.name %></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="/admin/football/tournament/update-team" method="POST" enctype="multipart/form-data">
                            <div class="modal-body">
                                <input type="hidden" name="tournamentId" value="<%= tournament._id %>">
                                <input type="hidden" name="teamId" value="<%= team.id %>">
                                
                                <div class="mb-3">
                                    <label class="form-label">Tên Đội</label>
                                    <input type="text" class="form-control" name="teamName" value="<%= team.name %>" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Logo</label>
                                    <input type="file" class="form-control" name="teamLogo" accept="image/*">
                                    <% if (team.logo && team.logo !== 'default.png') { %>
                                        <div class="mt-2">
                                            <small>Logo hiện tại:</small>
                                            <img src="/static/uploads/tournaments/<%= team.logo %>" width="50">
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                <button type="submit" class="btn btn-primary">Lưu Thay Đổi</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Manage Members Modal -->
            <div class="modal fade" id="manageMembersModal<%= team.id %>" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Thành viên: <%= team.name %></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Add Member Form -->
                            <form action="/admin/football/tournament/add-team-member" method="POST" enctype="multipart/form-data" class="mb-4 p-3 bg-light rounded" data-team-id="<%= team.id %>">
                                <input type="hidden" name="tournamentId" value="<%= tournament._id %>">
                                <input type="hidden" name="teamId" value="<%= team.id %>">
                                <div class="row align-items-end">
                                    <div class="col-md-5">
                                        <label class="form-label">Tên Cầu Thủ</label>
                                        <input type="text" class="form-control" name="memberName" required>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label">Avatar</label>
                                        <input type="file" class="form-control" name="memberAvatar" accept="image/*">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success w-100" onclick="submitAddMember(this)">Thêm</button>
                                    </div>
                                </div>
                            </form>

                            <!-- Members List -->
                            <h6>Danh sách cầu thủ (<span id="member-count-<%= team.id %>"><%= team.members ? team.members.length : 0 %></span>)</h6>
                            <ul class="list-group" id="member-list-<%= team.id %>">
                                <% if (team.members && team.members.length > 0) { %>
                                    <% team.members.forEach((member, i) => { %>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="fw-bold me-3"><%= i + 1 %>.</span>
                                                <% if (member.avatar && member.avatar !== 'default-avatar.png') { %>
                                                    <img src="/static/uploads/tournaments/<%= member.avatar %>" class="rounded-circle me-2" width="30" height="30">
                                                <% } else { %>
                                                    <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center text-white" style="width: 30px; height: 30px;">
                                                        <i class="fa fa-user"></i>
                                                    </div>
                                                <% } %>
                                                <span><%= member.name %></span>
                                            </div>
                                        </li>
                                    <% }) %>
                                <% } else { %>
                                    <li class="list-group-item text-center text-muted">Chưa có thành viên nào</li>
                                <% } %>
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
        <% }) %>
    <% } %>

    <!-- Match Detail Modal (Dynamic) -->
    <div class="modal fade" id="matchDetailModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="matchDetailTitle">Chi Tiết Trận Đấu</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Score Header -->
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
                        <h4 class="text-primary mb-0" id="matchTeam1Name">Team 1</h4>
                        <div class="d-flex align-items-center">
                            <input type="number" id="matchScore1" class="form-control text-center mx-2 fw-bold fs-4" style="width: 80px;" placeholder="0">
                            <span class="fw-bold fs-3">-</span>
                            <input type="number" id="matchScore2" class="form-control text-center mx-2 fw-bold fs-4" style="width: 80px;" placeholder="0">
                        </div>
                        <h4 class="text-primary mb-0" id="matchTeam2Name">Team 2</h4>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs nav-fill" id="matchTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold" id="lineup-tab" data-bs-toggle="tab" data-bs-target="#lineup" type="button" role="tab">
                                <i class="fa fa-users me-2"></i>Đội Hình & Sự Kiện
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab">
                                <i class="fa fa-list-alt me-2"></i>Diễn Biến (Nhập liệu)
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Lineup Tab -->
                        <div class="tab-pane fade show active" id="lineup" role="tabpanel">
                            <div class="row g-0">
                                <!-- Team 1 Field -->
                                <div class="col-lg-6 border-end">
                                    <div class="p-2 text-center bg-light border-bottom fw-bold" id="lineupTeam1Name">Team 1</div>
                                    <div class="soccer-pitch-container">
                                        <div class="soccer-pitch" id="pitch-team1">
                                            <!-- Positions will be generated here -->
                                        </div>
                                    </div>
                                    <div class="p-3 bg-light border-top">
                                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Dự bị (Kéo thả vào sân)</h6>
                                        <div class="subs-container" id="subs-team1" ondrop="drop(event)" ondragover="allowDrop(event)">
                                            <!-- Subs generated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Team 2 Field -->
                                <div class="col-lg-6">
                                    <div class="p-2 text-center bg-light border-bottom fw-bold" id="lineupTeam2Name">Team 2</div>
                                    <div class="soccer-pitch-container">
                                        <div class="soccer-pitch" id="pitch-team2">
                                            <!-- Positions will be generated here -->
                                        </div>
                                    </div>
                                    <div class="p-3 bg-light border-top">
                                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Dự bị (Kéo thả vào sân)</h6>
                                        <div class="subs-container" id="subs-team2" ondrop="drop(event)" ondragover="allowDrop(event)">
                                            <!-- Subs generated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Events Tab (Placeholder) -->
                        <div class="tab-pane fade" id="events" role="tabpanel">
                            <div class="p-4 text-center text-muted">
                                <i class="fa fa-cogs fa-3x mb-3"></i>
                                <p>Tính năng nhập liệu diễn biến chi tiết đang được phát triển.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary px-4" onclick="saveMatchDetails()">
                        <i class="fa fa-save me-2"></i>Lưu Cập Nhật
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .soccer-pitch-container {
            padding: 20px;
            background: #2e7d32;
            display: flex;
            justify-content: center;
        }
        .soccer-pitch {
            width: 300px;
            height: 400px;
            border: 2px solid rgba(255,255,255,0.8);
            position: relative;
            background-image: 
                linear-gradient(rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
            border-radius: 5px;
        }
        /* Center Circle */
        .soccer-pitch::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
        }
        /* Halfway Line */
        .soccer-pitch::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255,255,255,0.5);
        }

        .player-position {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .player-position:hover {
            z-index: 10;
        }
        .player-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #ddd;
            border: 2px solid white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .player-name {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            white-space: nowrap;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .position-label {
            position: absolute;
            top: -15px;
            color: rgba(255,255,255,0.8);
            font-size: 10px;
            font-weight: bold;
        }

        .subs-container {
            min-height: 100px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: white;
        }
        .sub-player {
            width: 60px;
            text-align: center;
            cursor: grab;
        }
        .sub-player:active {
            cursor: grabbing;
        }
        .sub-player .player-avatar {
            width: 40px;
            height: 40px;
            margin: 0 auto 5px;
        }
        .sub-player .player-name {
            background: #6c757d;
            font-size: 9px;
        }
    </style>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/admin/lib/chart/chart.min.js"></script>
    <script src="/static/admin/lib/easing/easing.min.js"></script>
    <script src="/static/admin/lib/waypoints/waypoints.min.js"></script>
    <script src="/static/admin/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="/static/admin/lib/tempusdominus/js/moment.min.js"></script>
    <script src="/static/admin/lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="/static/admin/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Template Javascript -->
    <script src="/static/admin/js/main.js"></script>

    <script>
        const tournamentData = JSON.parse(decodeURIComponent('<%- encodeURIComponent(JSON.stringify(tournament)) %>'));
        let currentMatchId = null;
        let currentMatch = null;

        // Position Configs (Simple approximations)
        const PITCH_CONFIGS = {
            '5': [
                {role: 'GK', top: '90%', left: '50%'},
                {role: 'DF', top: '70%', left: '30%'}, {role: 'DF', top: '70%', left: '70%'},
                {role: 'FW', top: '30%', left: '30%'}, {role: 'FW', top: '30%', left: '70%'}
            ],
            '7': [
                {role: 'GK', top: '90%', left: '50%'},
                {role: 'CD', top: '75%', left: '50%'},
                {role: 'LM', top: '50%', left: '15%'}, {role: 'RM', top: '50%', left: '85%'}, {role: 'CM', top: '50%', left: '50%'},
                {role: 'FW', top: '25%', left: '35%'}, {role: 'FW', top: '25%', left: '65%'}
            ]
        };

        function openMatchDetail(matchId) {
            currentMatchId = matchId;
            currentMatch = null;

            // Find match
            if (tournamentData.fixtures) {
                for (const group of tournamentData.fixtures) {
                    const m = group.matches.find(m => m.id === matchId);
                    if (m) {
                        currentMatch = m;
                        break;
                    }
                }
            }

            if (!currentMatch) return alert('Match not found!');

            // Populate Header
            document.getElementById('matchTeam1Name').innerText = currentMatch.team1;
            document.getElementById('matchTeam2Name').innerText = currentMatch.team2;
            document.getElementById('matchScore1').value = currentMatch.score1;
            document.getElementById('matchScore2').value = currentMatch.score2;

            // Render Lineups
            const pitchType = tournamentData.pitchType || '7'; // Default to 7
            const positions = PITCH_CONFIGS[pitchType] || PITCH_CONFIGS['7'];

            renderTeamLineup('team1', currentMatch.team1, currentMatch.lineup1 || [], positions);
            renderTeamLineup('team2', currentMatch.team2, currentMatch.lineup2 || [], positions);

            // Show Modal
            new bootstrap.Modal(document.getElementById('matchDetailModal')).show();
        }

        function renderTeamLineup(side, teamName, currentLineup, positions) {
            const team = tournamentData.teams.find(t => t.name === teamName);
            const members = team ? (team.members || []) : [];
            
            const pitchContainer = document.getElementById(`pitch-${side}`);
            const subsContainer = document.getElementById(`subs-${side}`);
            
            pitchContainer.innerHTML = '';
            subsContainer.innerHTML = '';

            // 1. Render Pitch Positions
            positions.forEach((pos, index) => {
                const posDiv = document.createElement('div');
                posDiv.className = 'player-position';
                posDiv.style.top = pos.top;
                posDiv.style.left = pos.left;
                posDiv.setAttribute('data-role', pos.role);
                posDiv.setAttribute('data-index', index);
                posDiv.ondrop = (e) => drop(e, side);
                posDiv.ondragover = allowDrop;

                // Check if player is assigned
                const assignedPlayerId = currentLineup[index];
                const player = assignedPlayerId ? members.find(m => m.id === assignedPlayerId || m.name === assignedPlayerId) : null;

                if (player) {
                    posDiv.innerHTML = `
                        <div class="position-label">${pos.role}</div>
                        <div class="player-avatar" draggable="true" ondragstart="drag(event, '${player.id}', '${side}', 'field', ${index})">
                            ${player.avatar && player.avatar !== 'default-avatar.png' ? 
                                `<img src="/static/uploads/tournaments/${player.avatar}">` : 
                                `<i class="fa fa-user text-secondary"></i>`}
                        </div>
                        <div class="player-name">${player.name}</div>
                    `;
                } else {
                    posDiv.innerHTML = `
                        <div class="position-label">${pos.role}</div>
                        <div class="player-avatar bg-transparent border-dashed" style="border-style: dashed; opacity: 0.5;">
                            <i class="fa fa-plus text-white"></i>
                        </div>
                        <div class="player-name bg-transparent text-white-50">Trống</div>
                    `;
                }
                pitchContainer.appendChild(posDiv);
            });

            // 2. Render Subs (Everyone not in lineup)
            members.forEach(member => {
                // Check if member is in lineup (by ID or Name fallback)
                const isInLineup = currentLineup.includes(member.id) || currentLineup.includes(member.name);
                
                if (!isInLineup) {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'sub-player';
                    subDiv.draggable = true;
                    subDiv.ondragstart = (e) => drag(e, member.id, side, 'sub');
                    subDiv.innerHTML = `
                        <div class="player-avatar">
                            ${member.avatar && member.avatar !== 'default-avatar.png' ? 
                                `<img src="/static/uploads/tournaments/${member.avatar}">` : 
                                `<div class="bg-secondary w-100 h-100 d-flex align-items-center justify-content-center text-white"><i class="fa fa-user"></i></div>`}
                        </div>
                        <div class="player-name">${member.name}</div>
                    `;
                    subsContainer.appendChild(subDiv);
                }
            });
        }

        // Drag & Drop Logic
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev, playerId, side, source, index) {
            ev.dataTransfer.setData("playerId", playerId);
            ev.dataTransfer.setData("side", side);
            ev.dataTransfer.setData("source", source); // 'field' or 'sub'
            if (index !== undefined) ev.dataTransfer.setData("index", index);
        }

        function drop(ev, targetSide) {
            ev.preventDefault();
            const playerId = ev.dataTransfer.getData("playerId");
            const side = ev.dataTransfer.getData("side");
            
            // Prevent cross-team transfers
            // targetSide might be undefined if dropped on subs container directly, need to infer
            if (!targetSide) {
                // Check parent id
                let p = ev.target;
                while(p && !p.id.startsWith('subs-') && !p.id.startsWith('pitch-')) {
                    p = p.parentElement;
                }
                if (p) targetSide = p.id.split('-')[1];
            }

            if (side !== targetSide) return;

            // Determine Target Type (Field Position or Subs)
            let target = ev.target;
            let targetType = 'sub';
            let targetIndex = -1;

            // Traverse up to find position container
            let posDiv = target.closest('.player-position');
            if (posDiv) {
                targetType = 'field';
                targetIndex = parseInt(posDiv.getAttribute('data-index'));
            }

            // Update Data
            const lineupKey = side === 'team1' ? 'lineup1' : 'lineup2';
            if (!currentMatch[lineupKey]) currentMatch[lineupKey] = [];
            
            // Ensure lineup array is big enough
            const pitchType = tournamentData.pitchType || '7';
            const size = (PITCH_CONFIGS[pitchType] || PITCH_CONFIGS['7']).length;
            while(currentMatch[lineupKey].length < size) currentMatch[lineupKey].push(null);

            const source = ev.dataTransfer.getData("source");
            const sourceIndex = parseInt(ev.dataTransfer.getData("index"));

            if (targetType === 'field') {
                // Moving to Field
                
                // If moving from another field position, clear old one
                if (source === 'field') {
                    currentMatch[lineupKey][sourceIndex] = null;
                }

                // If target has a player, move them to subs (implicitly handled by render) or swap?
                // For simplicity: Overwrite (rendering will put displaced player in subs)
                // Actually, swap is better UX, but harder. Let's just Overwrite/Swap if from field.
                
                if (source === 'field') {
                    // Swap
                    const existingPlayer = currentMatch[lineupKey][targetIndex];
                    currentMatch[lineupKey][targetIndex] = playerId;
                    currentMatch[lineupKey][sourceIndex] = existingPlayer; 
                } else {
                    // From Subs: Just place. Old player at target goes to subs.
                    currentMatch[lineupKey][targetIndex] = playerId;
                }

            } else {
                // Moving to Subs
                if (source === 'field') {
                    currentMatch[lineupKey][sourceIndex] = null;
                }
            }

            // Re-render
            const pitchConfig = PITCH_CONFIGS[pitchType] || PITCH_CONFIGS['7'];
            const teamName = side === 'team1' ? currentMatch.team1 : currentMatch.team2;
            renderTeamLineup(side, teamName, currentMatch[lineupKey], pitchConfig);
        }

        function saveMatchDetails() {
            if (!currentMatch) return;

            const score1 = document.getElementById('matchScore1').value;
            const score2 = document.getElementById('matchScore2').value;

            const data = {
                tournamentId: tournamentData._id,
                matchId: currentMatch.id,
                score1: score1,
                score2: score2,
                lineup1: currentMatch.lineup1,
                lineup2: currentMatch.lineup2
            };

            const btn = document.querySelector('#matchDetailModal .btn-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Đang lưu...';

            fetch('/admin/football/tournament/update-match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json().catch(() => ({}))) // Handle non-JSON response gracefully
            .then(res => {
                // If it was a redirect or text, res might be empty or string. 
                // Since existing controller redirects, we might get a page back if we don't change controller to return JSON.
                // We SHOULD change controller to return JSON for this new modal.
                // But if we can't, we just reload.
                location.reload();
            })
            .catch(err => {
                console.error(err);
                location.reload(); // Fallback
            });
        }

        function submitAddMember(btn) {
            const form = btn.closest('form');
            if (!form) {
                return;
            }

            const formData = new FormData(form);
            const teamId = form.getAttribute('data-team-id');
            
            if (!teamId) {
                alert('Lỗi: Không tìm thấy ID đội bóng. Vui lòng tải lại trang.');
                return;
            }

            const memberNameInput = form.querySelector('input[name="memberName"]');
            if (!memberNameInput || !memberNameInput.value.trim()) {
                alert('Vui lòng nhập tên thành viên!');
                if(memberNameInput) memberNameInput.focus();
                return;
            }

            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang thêm...';

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(async response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.message || 'Server Error');
                    }
                    return data;
                } else {
                    const text = await response.text();
                    throw new Error('Server returned non-JSON response');
                }
            })
            .then(data => {
                if (data.success) {
                    // Reset inputs
                    form.querySelector('input[name="memberName"]').value = '';
                    form.querySelector('input[name="memberAvatar"]').value = '';
                    
                    // Update list
                    const list = document.getElementById(`member-list-${teamId}`);
                    const countSpan = document.getElementById(`member-count-${teamId}`);
                    
                    const member = data.member;
                    
                    // Check if the list only contains the "no members" item
                    const emptyMsg = list.querySelector('.text-muted');
                    let index = 1;
                    if (emptyMsg) {
                        emptyMsg.remove();
                    } else {
                        index = list.children.length + 1;
                    }
                    
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="fw-bold me-3">${index}.</span>
                            ${member.avatar && member.avatar !== 'default-avatar.png' ? 
                                `<img src="/static/uploads/tournaments/${member.avatar}" class="rounded-circle me-2" width="30" height="30">` : 
                                `<div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center text-white" style="width: 30px; height: 30px;"><i class="fa fa-user"></i></div>`
                            }
                            <span>${member.name}</span>
                        </div>
                    `;
                    
                    list.appendChild(li);
                    
                    // Update count
                    if (countSpan) {
                        countSpan.innerText = parseInt(countSpan.innerText) + 1;
                    }
                    
                    // Focus back to name input
                    memberNameInput.focus();
                } else {
                    alert('Lỗi: ' + (data.message || 'Không thể thêm thành viên'));
                }
            })
            .catch(err => {
                alert('Đã xảy ra lỗi: ' + err.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            });
        }
    </script>
    <script>
        $(document).ready(function() {
            const bracketData = JSON.parse(decodeURIComponent('<%- encodeURIComponent(JSON.stringify(tournament.bracketData || null)) %>'));
            
            if (bracketData) {
                $('#bracket-container').bracket({
                    init: bracketData,
                    // Admin can edit scores here? 
                    // For now, let's keep it read-only or enable save if needed. 
                    // The user didn't explicitly ask for editing bracket structure here, just "add bracket".
                    // But usually admin wants to edit.
                    // However, editing bracket structure is complex (requires save callback).
                    // Given the request "thêm phần bracket vào luôn đi", visualization is the first step.
                    // If I enable edit, I need a save endpoint.
                    // The reference file had save logic: save: function(data) { ... }
                    // I'll stick to read-only for now unless I see a save-bracket endpoint.
                    // I'll enable edit ONLY if I can implement the save.
                    // Let's check if there is a save-bracket endpoint in controller.
                });
            } else {
                $('#bracket-container').html('<p class="text-muted">Chưa có dữ liệu sơ đồ. Vui lòng kết thúc vòng bảng để tạo.</p>');
            }

            // Fix for bracket rendering when hidden in tab
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                if (e.target.id === 'bracket-tab' && bracketData) {
                    $('#bracket-container').empty();
                    $('#bracket-container').bracket({
                        init: bracketData
                    });
                }
            });
        });
    </script>
</body>

</html>
