<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>H·ªì S∆° C√° Nh√¢n - Sports Tournament</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet"> 

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="static/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="static/css/style.css" rel="stylesheet">
    
    <style>
        .profile-header {
            background-color: #EDF1FF;
            padding: 30px 0;
            text-align: center;
        }
        .profile-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .profile-nav {
            background: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .profile-nav .nav-link {
            padding: 15px 20px;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
        }
        .profile-nav .nav-link:hover, .profile-nav .nav-link.active {
            background: #EDF1FF;
            color: #FF6F61;
            font-weight: 500;
        }
        /* Custom Styles for Tabs */
        .nav-pills .nav-link.active, .nav-pills .show>.nav-link {
            background-color: #FF6F61;
            color: #fff !important;
        }
        /* View/Edit Mode Styles */
        .view-mode .form-control {
            background-color: #f8f9fa;
            border: none;
            box-shadow: none;
            pointer-events: none; /* Disable interaction in view mode */
        }
        .view-mode input[type="radio"] {
            pointer-events: none;
        }
        #edit-buttons {
            display: none;
        }
        #update-btn-container {
            display: block;
        }
        .edit-mode #edit-buttons {
            display: block;
        }
        .edit-mode #update-btn-container {
            display: none;
        }
        .edit-mode .form-control {
            background-color: #fff;
            border: 1px solid #ced4da;
            pointer-events: auto;
        }
        .edit-mode input[type="radio"] {
            pointer-events: auto;
        }
        #avatar-upload-container {
            display: none;
        }
        .edit-mode #avatar-upload-container {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Topbar Start -->
    <%- include("partical/headercomponent.ejs") %>
    <!-- Topbar End -->

    <!-- Navbar Start -->
    <div class="container-fluid">
        <div class="row border-top px-xl-5">
            <div class="col-lg-12">
                <%- include("partical/menucomponent.ejs") %>
            </div>
        </div>
    </div>
    <!-- Navbar End -->

    <!-- Page Header Start -->
    <div class="page-header container-fluid bg-primary d-flex flex-column align-items-center justify-content-center">
        <h1 class="display-3 text-uppercase mb-3">H·ªì s∆° c√° nh√¢n</h1>
        <div class="d-inline-flex text-white">
            <h6 class="text-uppercase m-0"><a class="text-white" href="">Home</a></h6>
            <h6 class="m-0 px-3">/</h6>
            <h6 class="text-uppercase m-0">H·ªì S∆°</h6>
        </div>
    </div>
    
    <!-- Page Header End -->

    <!-- Profile Start -->
    <div class="container-fluid pt-5">
        <div class="row px-xl-5">
            <div class="col-lg-4 mb-5">
                <div class="profile-header mb-4 rounded">
                    <img src="static/img/user.jpg" alt="Profile Image" class="profile-img" id="display-avatar">
                    <h3 class="mb-0" id="display-name">Loading...</h3>
                    <p class="text-muted" id="display-email">...</p>
                    
                    <div id="avatar-upload-container" class="mt-3">
                        <input type="file" id="avatar-input" class="form-control-file" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="document.getElementById('avatar-input').click()">
                            <i class="fa fa-camera"></i> ƒê·ªïi Avatar
                        </button>
                        <small id="file-name" class="d-block mt-2 text-muted"></small>
                    </div>
                </div>
                
                <div class="profile-nav rounded">
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <a class="nav-link active" id="v-pills-profile-tab" data-toggle="pill" href="#v-pills-profile" role="tab" aria-controls="v-pills-profile" aria-selected="true"><i class="fa fa-user mr-2"></i> Th√¥ng Tin C√° Nh√¢n</a>
                        <a class="nav-link" id="v-pills-myteam-tab" data-toggle="pill" href="#v-pills-myteam" role="tab" aria-controls="v-pills-myteam" aria-selected="false"><i class="fa fa-users mr-2"></i> Th√¥ng Tin ƒê·ªôi</a>
                        <a class="nav-link" id="v-pills-history-tab" data-toggle="pill" href="#v-pills-history" role="tab" aria-controls="v-pills-history" aria-selected="false"><i class="fa fa-history mr-2"></i> L·ªãch S·ª≠ ƒêƒÉng K√Ω</a>
                        <a class="nav-link" href="#" id="sidebar-logout"><i class="fa fa-sign-out-alt mr-2"></i> ƒêƒÉng Xu·∫•t</a>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-8 mb-5">
                <div class="tab-content" id="v-pills-tabContent">
                    <!-- Tab 1: Profile Info -->
                    <div class="tab-pane fade show active" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white border-bottom p-4">
                                <h4 class="card-title mb-0">Th√¥ng Tin T√†i Kho·∫£n</h4>
                            </div>
                            <div class="card-body p-4 view-mode" id="profile-container">
                                <form id="profile-form">
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label font-weight-bold">H·ªç v√† T√™n</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="username" name="username" required>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label font-weight-bold">Email</label>
                                        <div class="col-sm-9">
                                            <input type="email" class="form-control" id="email" name="email" readonly>
                                            <small class="form-text text-muted">Email kh√¥ng th·ªÉ thay ƒë·ªïi.</small>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label font-weight-bold">S·ªë ƒêi·ªán Tho·∫°i</label>
                                        <div class="col-sm-9">
                                            <input type="tel" class="form-control" id="phone" name="phone">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label font-weight-bold">ƒê·ªãa Ch·ªâ</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="address" name="address">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label font-weight-bold">Ng√†y Sinh</label>
                                        <div class="col-sm-9">
                                            <input type="date" class="form-control" id="dob" name="dob">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label font-weight-bold">Gi·ªõi T√≠nh</label>
                                        <div class="col-sm-9 d-flex align-items-center">
                                            <div class="custom-control custom-radio mr-4">
                                                <input type="radio" id="gender-male" name="gender" value="male" class="custom-control-input">
                                                <label class="custom-control-label" for="gender-male">Nam</label>
                                            </div>
                                            <div class="custom-control custom-radio">
                                                <input type="radio" id="gender-female" name="gender" value="female" class="custom-control-input">
                                                <label class="custom-control-label" for="gender-female">N·ªØ</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group row mt-4">
                                        <div class="col-sm-9 offset-sm-3">
                                            <div id="update-btn-container">
                                                <button type="button" class="btn btn-primary px-4" id="btn-enable-edit">C·∫≠p Nh·∫≠t Th√¥ng Tin</button>
                                            </div>
                                            <div id="edit-buttons">
                                                <button type="submit" class="btn btn-primary px-4 mr-2">L∆∞u Thay ƒê·ªïi</button>
                                                <button type="button" class="btn btn-secondary px-4" id="btn-cancel-edit">H·ªßy</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Team Analysis Charts MOVED to My Team Tab -->
                    </div>

                    <!-- Tab 2: My Team Info -->
                    <div class="tab-pane fade" id="v-pills-myteam" role="tabpanel" aria-labelledby="v-pills-myteam-tab">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white border-bottom p-4">
                                <h4 class="card-title mb-0">Th√¥ng Tin ƒê·ªôi C·ªßa T√¥i</h4>
                                <small class="text-muted">L∆∞u th√¥ng tin ƒë·ªôi ƒë·ªÉ ƒëƒÉng k√Ω gi·∫£i ƒë·∫•u nhanh ch√≥ng h∆°n.</small>
                            </div>
                            <div class="card-body p-4">
                                <form id="my-team-form" enctype="multipart/form-data">
                                    <h5 class="mb-3 text-primary border-left border-primary pl-2">Th√¥ng Tin Chung</h5>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">T√™n ƒê·ªôi <span class="text-danger">*</span></label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" name="teamName" id="teamName" required>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">Logo ƒê·ªôi</label>
                                        <div class="col-sm-9">
                                            <div class="d-flex align-items-center">
                                                <img src="" id="team-logo-preview" class="img-thumbnail mr-3" style="width: 80px; height: 80px; object-fit: cover; display: none;">
                                                <div class="custom-file">
                                                    <input type="file" class="custom-file-input" id="teamLogo" name="logo" accept="image/*">
                                                    <label class="custom-file-label" for="teamLogo">Ch·ªçn ·∫£nh...</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">Ng∆∞·ªùi ƒê·∫°i Di·ªán</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" name="representative" id="teamRepresentative">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">S·ªë ƒêi·ªán Tho·∫°i</label>
                                        <div class="col-sm-9">
                                            <input type="tel" class="form-control" name="phone" id="teamPhone">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">Email Li√™n H·ªá</label>
                                        <div class="col-sm-9">
                                            <input type="email" class="form-control" name="email" id="teamEmail">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">Gi·ªõi Thi·ªáu</label>
                                        <div class="col-sm-9">
                                            <textarea class="form-control" name="description" id="teamDescription" rows="3"></textarea>
                                        </div>
                                    </div>

                                    <h5 class="mb-3 mt-4 text-primary border-left border-primary pl-2 d-flex justify-content-between align-items-center">
                                        Danh S√°ch Th√†nh Vi√™n
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-member">
                                            <i class="fa fa-plus"></i> Th√™m Th√†nh Vi√™n
                                        </button>
                                    </h5>
                                    <div id="members-container">
                                        <!-- Members will be added here dynamically -->
                                        <div class="text-center text-muted py-3" id="no-members-msg">Ch∆∞a c√≥ th√†nh vi√™n n√†o.</div>
                                    </div>

                                    <div class="mt-4 pt-3 border-top text-right">
                                        <button type="submit" class="btn btn-primary px-4" id="btn-save-team">
                                            <i class="fa fa-save mr-2"></i> L∆∞u Th√¥ng Tin ƒê·ªôi
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Team Analysis Charts -->
                        <div class="card border-0 shadow-sm mb-4" id="team-stats-section" style="display: none;">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center p-4">
                                <h4 class="card-title mb-0 text-white"><i class="fa fa-chart-bar mr-2"></i> Ph√¢n T√≠ch ƒê·ªôi B√≥ng</h4>
                                <div id="stats-tournament-selector-group" style="display: none;">
                                    <select class="form-control form-control-sm" id="stats-tournament-select" style="min-width: 200px;"></select>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                <div class="row">
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-center mb-3">T·ª∑ L·ªá K·∫øt Qu·∫£</h6>
                                        <div style="height: 300px; position: relative;">
                                            <canvas id="resultsChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-center mb-3">Hi·ªáu Su·∫•t Ghi B√†n Qua C√°c Tr·∫≠n</h6>
                                        <div style="height: 300px; position: relative;">
                                            <canvas id="goalsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 3: Registration History -->
                    <div class="tab-pane fade" id="v-pills-history" role="tabpanel" aria-labelledby="v-pills-history-tab">
                        <div class="bg-light p-4 rounded shadow-sm">
                            <h4 class="mb-4 text-uppercase text-primary border-bottom pb-2">L·ªãch S·ª≠ ƒêƒÉng K√Ω ƒê·ªôi</h4>
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Ng√†y ƒêƒÉng K√Ω</th>
                                            <th>Gi·∫£i ƒê·∫•u</th>
                                            <th>T√™n ƒê·ªôi</th>
                                            <th>Tr·∫°ng Th√°i</th>
                                            <th>Ghi Ch√∫</th>
                                        </tr>
                                    </thead>
                                    <tbody id="registration-history-body">
                                        <tr><td colspan="5" class="text-center text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    <!-- Profile End -->

    <!-- Footer Start -->
    <%- include("partical/footercomponent.ejs") %>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-primary back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="static/lib/easing/easing.min.js"></script>
    <script src="static/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="/static/admin/lib/chart/chart.min.js"></script>

    <!-- Contact Javascript File -->
    <script src="static/mail/jqBootstrapValidation.min.js"></script>
    <script src="static/mail/contact.js"></script>

    <!-- Template Javascript -->
    <script src="static/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            var originalData = {};

            // Helper function to switch modes
            function setEditMode(enable) {
                if (enable) {
                    $('#profile-container').removeClass('view-mode').addClass('edit-mode');
                    $('#avatar-upload-container').show();
                } else {
                    $('#profile-container').removeClass('edit-mode').addClass('view-mode');
                    $('#avatar-upload-container').hide();
                }
            }

            // Load Profile Data
            loadProfileData();

            function loadProfileData() {
                $.ajax({
                    url: '/profile/data',
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token },
                    success: function(response) {
                        console.log('Profile Data Response:', response);
                        if (response.success) {
                            var user = response.data;
                            originalData = user; // Save for cancel
                            
                            // --- Populate Profile Info ---
                            $('#username').val(user.username);
                            $('#display-name').text(user.username);
                            $('#email').val(user.email);
                            $('#display-email').text(user.email);
                            $('#phone').val(user.phone || '');
                            $('#address').val(user.address || '');
                            $('#dob').val(user.dob || '');
                            
                            if (user.gender) {
                                $('input[name="gender"][value="' + user.gender + '"]').prop('checked', true);
                            }
                            
                            if (user.avatar) {
                                $('#display-avatar').attr('src', user.avatar);
                            } else {
                                $('#display-avatar').attr('src', 'static/img/user.jpg');
                            }

                            // --- Populate Registration History ---
                            if (response.registrations && response.registrations.length > 0) {
                                var html = '';
                                response.registrations.forEach(function(reg) {
                                    var statusBadge = '';
                                    var note = '';
                                    switch(reg.status) {
                                        case 'pending': 
                                            statusBadge = '<span class="badge badge-warning text-white">ƒêang ch·ªù duy·ªát</span>'; 
                                            note = 'H·ªì s∆° ƒëang ƒë∆∞·ª£c xem x√©t';
                                            break;
                                        case 'approved': 
                                            statusBadge = '<span class="badge badge-success">ƒê√£ duy·ªát</span>'; 
                                            note = 'ƒê·ªôi ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·∫£i ƒë·∫•u';
                                            break;
                                        case 'rejected': 
                                            statusBadge = '<span class="badge badge-danger">T·ª´ ch·ªëi</span>'; 
                                            note = 'H·ªì s∆° kh√¥ng h·ª£p l·ªá ho·∫∑c gi·∫£i ƒë√£ ƒë·ªß ƒë·ªôi';
                                            break;
                                        default: 
                                            statusBadge = '<span class="badge badge-secondary">' + reg.status + '</span>';
                                            note = '';
                                    }
                                    
                                    var date = new Date(reg.submittedAt).toLocaleDateString('vi-VN');
                                    var tournamentName = reg.tournamentId ? reg.tournamentId.name : 'Kh√¥ng x√°c ƒë·ªãnh';
                                    
                                    html += '<tr>' +
                                        '<td>' + date + '</td>' +
                                        '<td>' + tournamentName + '</td>' +
                                        '<td>' + reg.teamName + '</td>' +
                                        '<td>' + statusBadge + '</td>' +
                                        '<td>' + note + '</td>' +
                                        '</tr>';
                                });
                                $('#registration-history-body').html(html);
                            } else {
                                $('#registration-history-body').html('<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒëƒÉng k√Ω n√†o.</td></tr>');
                            }

                            // --- Populate My Team Info ---
                            if (response.myTeam) {
                                var team = response.myTeam;
                                $('#teamName').val(team.teamName);
                                $('#teamRepresentative').val(team.representative);
                                $('#teamPhone').val(team.phone);
                                $('#teamEmail').val(team.email);
                                $('#teamDescription').val(team.description);
                                
                                if (team.logo && team.logo !== 'default.png') {
                                    $('#team-logo-preview').attr('src', '/static/uploads/avatars/' + team.logo).show();
                                }

                                $('#members-container').empty();
                                if (team.members && team.members.length > 0) {
                                    team.members.forEach(function(member) {
                                        addMemberRow(member);
                                    });
                                } else {
                                    $('#no-members-msg').show();
                                }
                            }

                            // --- Populate Team Stats Charts ---
                            if (response.teamStats && response.teamStats.length > 0) {
                                $('#team-stats-section').show();
                                var selector = $('#stats-tournament-select');
                                selector.empty();
                                
                                if (response.teamStats.length > 1) {
                                    $('#stats-tournament-selector-group').show();
                                } else {
                                    $('#stats-tournament-selector-group').hide();
                                }

                                response.teamStats.forEach(function(stat, index) {
                                    selector.append(new Option(stat.tournamentName + ' (' + stat.teamName + ')', index));
                                });

                                // Handle change
                                selector.off('change').on('change', function() {
                                    var index = $(this).val();
                                    renderTeamCharts(response.teamStats[index]);
                                });

                                // Initial render
                                renderTeamCharts(response.teamStats[0]);
                            } else {
                                $('#team-stats-section').hide();
                            }
                        }
                    },
                    error: function(xhr) {
                        if (xhr.status === 401) {
                            alert('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n');
                            localStorage.removeItem('token');
                            window.location.href = '/login';
                        } else {
                            alert('L·ªói t·∫£i th√¥ng tin: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.statusText));
                        }
                    }
                });
            }

            // --- Profile Info Handlers ---
            $('#btn-enable-edit').click(function() { setEditMode(true); });
            $('#btn-cancel-edit').click(function() { 
                setEditMode(false);
                // Reset simple fields
                $('#username').val(originalData.username);
                $('#phone').val(originalData.phone || '');
                $('#address').val(originalData.address || '');
                $('#dob').val(originalData.dob || '');
                if (originalData.gender) $('input[name="gender"][value="' + originalData.gender + '"]').prop('checked', true);
                else $('input[name="gender"]').prop('checked', false);
            });
            
            $('#avatar-input').change(function() {
                var file = this.files[0];
                if (file) {
                    $('#file-name').text(file.name);
                    var reader = new FileReader();
                    reader.onload = function(e) { $('#display-avatar').attr('src', e.target.result); }
                    reader.readAsDataURL(file);
                }
            });

            $('#profile-form').submit(function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                // ... (rest of profile submit logic is fine with FormData(this))
                // Just ensuring we append gender correctly if checked
                
                $.ajax({
                    url: '/profile/update',
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            loadProfileData(); // Reload to sync everything
                            setEditMode(false);
                        } else {
                            alert('L·ªói: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        alert('L·ªói c·∫≠p nh·∫≠t: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.statusText));
                    }
                });
            });

            // --- My Team Handlers ---

            // Add Member
            $('#btn-add-member').click(function() {
                $('#no-members-msg').hide();
                addMemberRow({});
            });

            // Remove Member (Delegated)
            $('#members-container').on('click', '.remove-member', function() {
                $(this).closest('.member-row').remove();
                if ($('#members-container').children().length === 0) {
                    $('#no-members-msg').show();
                }
            });

            // Logo Preview
            $('#teamLogo').change(function() {
                var file = this.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        $('#team-logo-preview').attr('src', e.target.result).show();
                    }
                    reader.readAsDataURL(file);
                    $(this).next('.custom-file-label').text(file.name);
                }
            });

            // Submit Team Form
            $('#my-team-form').submit(function(e) {
                e.preventDefault();
                var formData = new FormData(this);

                $.ajax({
                    url: '/profile/my-team/update',
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            alert('ƒê√£ l∆∞u th√¥ng tin ƒë·ªôi th√†nh c√¥ng!');
                            // No need to reload, just update UI if needed
                        } else {
                            alert('L·ªói: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        alert('L·ªói l∆∞u th√¥ng tin: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.statusText));
                    }
                });
            });

            // Sidebar logout
            $('#sidebar-logout').click(function(e) {
                e.preventDefault();
                localStorage.removeItem('token');
                window.location.href = '/login';
            });
        });

        // Global functions for inline events
        function addMemberRow(member) {
            var avatarUrl = member.avatar ? '/static/uploads/avatars/' + member.avatar : '/static/img/user.jpg';
            if (member.avatar && member.avatar.indexOf('http') === 0) avatarUrl = member.avatar; // Handle absolute URLs if any

            var html = `
            <div class="member-row border rounded p-3 mb-3 bg-white position-relative shadow-sm">
                <button type="button" class="close position-absolute remove-member" style="top: 10px; right: 15px;">&times;</button>
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <img src="${avatarUrl}" class="img-thumbnail mb-2 member-avatar-preview" style="width: 80px; height: 80px; object-fit: cover;">
                        <input type="hidden" name="existingMemberAvatar" value="${member.avatar || ''}">
                        <input type="hidden" name="memberHasNewAvatar" value="false" class="has-new-avatar">
                        <div class="custom-file mt-1">
                            <input type="file" class="custom-file-input" name="memberAvatar" accept="image/*" onchange="previewMemberAvatar(this)">
                            <label class="custom-file-label text-truncate" style="font-size: 0.8rem;">·∫¢nh</label>
                        </div>
                    </div>
                    <div class="col-md-10">
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label class="small font-weight-bold">H·ªç v√† T√™n</label>
                                <input type="text" class="form-control form-control-sm" name="memberName" value="${member.name || ''}" required placeholder="Nh·∫≠p t√™n th√†nh vi√™n">
                            </div>
                            <div class="col-md-3 form-group">
                                <label class="small font-weight-bold">S·ªë √Åo</label>
                                <input type="number" class="form-control form-control-sm" name="memberNumber" value="${member.number || ''}">
                            </div>
                            <div class="col-md-3 form-group">
                                <label class="small font-weight-bold">CCCD/CMND</label>
                                <input type="hidden" name="existingMemberCitizenIdImage" value="${member.citizenIdImage || ''}">
                                <input type="hidden" name="memberHasNewCitizen" value="false" class="has-new-citizen">
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" name="memberCitizenIdImage" accept="image/*" onchange="markNewCitizen(this)">
                                    <label class="custom-file-label text-truncate" style="font-size: 0.8rem;">File ·∫£nh</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
            $('#members-container').append(html);
        }

        function previewMemberAvatar(input) {
            var file = input.files[0];
            if (file) {
                var row = $(input).closest('.member-row');
                var reader = new FileReader();
                reader.onload = function(e) {
                    row.find('.member-avatar-preview').attr('src', e.target.result);
                }
                reader.readAsDataURL(file);
                row.find('.has-new-avatar').val('true');
                $(input).next('.custom-file-label').text(file.name);
            }
        }

        function markNewCitizen(input) {
            var file = input.files[0];
            if (file) {
                $(input).closest('.col-md-3').find('.has-new-citizen').val('true');
                $(input).next('.custom-file-label').text(file.name);
            }
        }

        function renderTeamCharts(statData) {
            // Process Data
            var matches = statData.matches;
            var wins = 0, draws = 0, losses = 0;
            var labels = [];
            var goalsScored = [];
            var goalsConceded = [];
            
            matches.forEach(function(m) {
                var myScore = m.isTeam1 ? m.score1 : m.score2;
                var oppScore = m.isTeam1 ? m.score2 : m.score1;
                
                if (myScore > oppScore) wins++;
                else if (myScore === oppScore) draws++;
                else losses++;
                
                labels.push(m.matchLabel); // e.g. "V√≤ng 1" or Date
                goalsScored.push(myScore);
                goalsConceded.push(oppScore);
            });
            
            // 1. Results Chart (Doughnut)
            var ctxResults = document.getElementById('resultsChart').getContext('2d');
            if (resultsChartInstance) resultsChartInstance.destroy();
            
            // Check if data is empty
            var hasData = wins + draws + losses > 0;
            var data = hasData ? [wins, draws, losses] : [0, 0, 0];
            var bgColors = hasData ? ['#28a745', '#ffc107', '#dc3545'] : ['#e9ecef', '#e9ecef', '#e9ecef'];

            resultsChartInstance = new Chart(ctxResults, {
                type: 'doughnut',
                data: {
                    labels: ['Th·∫Øng', 'H√≤a', 'Thua'],
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
            
            // 2. Goals Chart (Bar)
            var ctxGoals = document.getElementById('goalsChart').getContext('2d');
            if (goalsChartInstance) goalsChartInstance.destroy();
            
            goalsChartInstance = new Chart(ctxGoals, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'B√†n Th·∫Øng',
                            data: goalsScored,
                            backgroundColor: '#007bff',
                            borderRadius: 4
                        },
                        {
                            label: 'B√†n Thua',
                            data: goalsConceded,
                            backgroundColor: '#dc3545',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }
    </script>
</body>
</html>
